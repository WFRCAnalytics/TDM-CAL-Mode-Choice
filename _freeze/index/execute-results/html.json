{
  "hash": "25183ad55899b79971052d788cff0683",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: Calculating the Mode Choice Calibration Parameters\nsubtitle: Using Household Travel Survey and UTA On-Board Survey Data\ndescription: Lorem Ipsum\nauthor:\n - name: Pukar Bhandari\n   email: pukar.bhandari@wfrc.utah.gov\n   affiliation:\n     - name: Wasatch Front Regional Council\n       url: \"https://wfrc.utah.gov/\"\ndate: \"2025-11-03\"\n---\n\n# Setup Environment\n\nThis section prepares the Python environment with all necessary libraries and configurations. We'll import data manipulation libraries (pandas, numpy), and visualization tools (matplotlib, seaborn).\n\n## Install Libraries\n\n```python\n!conda install -c conda-forge numpy pandas matplotlib seaborn requests pathlib BigQuery\n```\n\n## Import Libraries\n\n::: {#9af4117d .cell execution_count=1}\n``` {.python .cell-code}\nimport pandas as pd\nimport numpy as np\nimport matplotlib.pyplot as plt\nimport seaborn as sns\n\nimport importlib.util\nfrom pathlib import Path\nimport sys\nimport os\nimport requests\nimport io\n\nfrom dotenv import load_dotenv\nload_dotenv()\n```\n\n::: {.cell-output .cell-output-display execution_count=26}\n```\nTrue\n```\n:::\n:::\n\n\n## Environment Variables\n\n\n\n## Helper Functions\n\n::: {#0ddf2a9b .cell execution_count=2}\n``` {.python .cell-code}\ndef fetch_github(\n    url: str,\n    mode: str = \"private\",\n    token_env_var: str = \"GITHUB_TOKEN\"\n) -> requests.Response:\n    \"\"\"\n    Fetch content from GitHub repositories.\n\n    Args:\n        url: GitHub raw URL (e.g., https://raw.githubusercontent.com/...)\n        mode: \"public\" for public repos, \"private\" for private repos requiring authentication\n        token_env_var: Name of environment variable containing GitHub token (default: GITHUB_TOKEN)\n\n    Returns:\n        requests.Response object\n\n    Raises:\n        ValueError: If token is missing for private mode or invalid mode\n        requests.HTTPError: If request fails\n    \"\"\"\n    # Validate mode\n    if mode not in [\"public\", \"private\"]:\n        raise ValueError(f\"mode must be 'public' or 'private', got '{mode}'\")\n\n    if mode == \"public\":\n        response = requests.get(url, timeout=30)\n    else:\n        token = os.getenv(token_env_var)\n        if not token:\n            raise ValueError(\n                f\"GitHub token not found in environment variable '{token_env_var}'. \"\n                f\"Check your .env file has: {token_env_var}=your_token_here\"\n            )\n\n        headers = {\n            'Authorization': f'token {token}',\n            'Accept': 'application/vnd.github.v3.raw'\n        }\n        response = requests.get(url, headers=headers, timeout=30)\n\n    response.raise_for_status()\n    return response\n```\n:::\n\n\n::: {#ba04963a .cell execution_count=3}\n``` {.python .cell-code}\ndef calculate_categorical_shares(\n    df,\n    category_col,\n    weight_col='LINKED_WEIGHT',\n    group_cols=['Veh_Cat3p', 'Purp5_text', 'PK_OK'],\n    filter_condition=None,\n    category_mapping=None,\n    prefix='share',\n    purpose_by_period=['HBW', 'HBO', 'NHB'],  # Only HBC and HBSch get daily\n    purpose_daily=['HBC', 'HBSch']  # NEW: Purposes that only get daily (no peak/off-peak)\n):\n    \"\"\"\n    Calculate weighted shares of categories within groups, ensuring they sum to 1.\n\n    Parameters:\n    -----------\n    df : DataFrame\n        Input dataframe\n    category_col : str\n        Column containing the categories to calculate shares for\n    weight_col : str\n        Column containing weights for each observation\n    group_cols : list\n        Columns to group by (e.g., vehicle ownership, purpose, peak/off-peak)\n    filter_condition : str or None\n        Optional pandas query string to filter data before calculation\n    category_mapping : dict or None\n        Optional mapping to rename/recode categories\n    prefix : str\n        Prefix for output column names\n    purpose_by_period : list\n        Purposes that should NOT get daily aggregates\n    purpose_daily : list\n        Purposes that ONLY get daily aggregates (no peak/off-peak breakdown)\n\n    Returns:\n    --------\n    DataFrame with shares in wide format\n    \"\"\"\n\n    # Apply filter and copy in one step\n    if filter_condition:\n        df_work = df.query(filter_condition).copy()\n    else:\n        df_work = df.copy()\n\n    # Apply category mapping if provided\n    if category_mapping:\n        df_work[category_col] = df_work[category_col].map(category_mapping)\n        # Remove unmapped values\n        df_work = df_work.dropna(subset=[category_col])\n\n    # Remove any NaN values in key columns\n    df_work = df_work.dropna(subset=[category_col, weight_col] + group_cols)\n\n    # Convert Veh_Cat3p to string format for consistency\n    df_work['Veh_Cat3p'] = df_work['Veh_Cat3p'].astype(str)\n    # Map 3 to 3+ for display\n    # df_work['Veh_Cat3p'] = df_work['Veh_Cat3p'].replace('3', '3+')\n\n    # Initialize results dictionary\n    results = {}\n\n    # Calculate weighted shares for each group combination (peak/off-peak)\n    # BUT skip purpose_daily\n    for veh in sorted(df_work['Veh_Cat3p'].unique()):\n        for purpose in sorted(df_work['Purp5_text'].unique()):\n            # Skip peak/off-peak for daily-only purposes\n            if purpose in purpose_daily:\n                continue\n\n            for peak in sorted(df_work['PK_OK'].unique()):\n                subset = df_work.query(\n                    f\"Veh_Cat3p == '{veh}' & Purp5_text == '{purpose}' & PK_OK == '{peak}'\"\n                )\n\n                if len(subset) > 0:\n                    # Calculate weighted counts by category\n                    weighted_counts = subset.groupby(category_col)[weight_col].sum()\n                    total_weight = subset[weight_col].sum()\n\n                    for cat, weighted_count in weighted_counts.items():\n                        var_name = f\"{prefix}_{cat}_{veh}veh\"\n                        if var_name not in results:\n                            results[var_name] = {}\n                        results[var_name][(purpose, peak)] = weighted_count / total_weight\n\n    # Calculate \"_all\" aggregates for peak/off-peak (excluding daily-only purposes)\n    for purpose in sorted(df_work['Purp5_text'].unique()):\n        # Skip peak/off-peak for daily-only purposes\n        if purpose in purpose_daily:\n            continue\n\n        for peak in sorted(df_work['PK_OK'].unique()):\n            subset = df_work.query(f\"Purp5_text == '{purpose}' & PK_OK == '{peak}'\")\n\n            if len(subset) > 0:\n                weighted_counts = subset.groupby(category_col)[weight_col].sum()\n                total_weight = subset[weight_col].sum()\n\n                for cat, weighted_count in weighted_counts.items():\n                    var_name = f\"{prefix}_{cat}_all\"\n                    if var_name not in results:\n                        results[var_name] = {}\n                    results[var_name][(purpose, peak)] = weighted_count / total_weight\n\n    # Calculate daily aggregates for specified purposes only\n    daily_purposes = [p for p in df_work['Purp5_text'].unique()\n                     if p not in purpose_by_period]\n\n    for purpose in daily_purposes:\n        subset = df_work.query(f\"Purp5_text == '{purpose}'\")\n\n        if len(subset) > 0:\n            # For each vehicle category\n            for veh in sorted(df_work['Veh_Cat3p'].unique()):\n                veh_subset = subset.query(f\"Veh_Cat3p == '{veh}'\")\n                if len(veh_subset) > 0:\n                    weighted_counts = veh_subset.groupby(category_col)[weight_col].sum()\n                    total_weight = veh_subset[weight_col].sum()\n\n                    for cat, weighted_count in weighted_counts.items():\n                        var_name = f\"{prefix}_{cat}_{veh}veh\"\n                        if var_name not in results:\n                            results[var_name] = {}\n                        results[var_name][(purpose, 'Daily')] = weighted_count / total_weight\n\n            # For \"all\" vehicle categories\n            weighted_counts = subset.groupby(category_col)[weight_col].sum()\n            total_weight = subset[weight_col].sum()\n\n            for cat, weighted_count in weighted_counts.items():\n                var_name = f\"{prefix}_{cat}_all\"\n                if var_name not in results:\n                    results[var_name] = {}\n                results[var_name][(purpose, 'Daily')] = weighted_count / total_weight\n\n    # Convert to DataFrame\n    df_result = pd.DataFrame(results).T\n    df_result.columns = pd.MultiIndex.from_tuples(df_result.columns)\n    df_result = df_result.fillna(0)\n\n    # Sort index\n    df_result = df_result.sort_index()\n\n    return df_result\n```\n:::\n\n\n::: {#35d974ad .cell execution_count=4}\n``` {.python .cell-code}\n# Verify categorical shares sum to 1.0000\ndef verify_shares(df_shares, tolerance=0.01):\n    \"\"\"\n    Verify that shares sum to approximately 1 within each vehicle category group.\n\n    Now that we have separate rows for each vehicle ownership category (0veh, 1veh, 2veh, 3+veh, all),\n    we need to verify that shares sum to 1 within each vehicle category separately.\n    \"\"\"\n    print(\"=== Verifying Share Sums ===\\n\")\n\n    # Extract vehicle categories from index\n    # Assuming format: calib_share_{category}_{veh_category}\n    vehicle_categories = df_shares.index.str.extract(r'_(\\d\\+?veh|all)$')[0].unique()\n\n    print(f\"Vehicle categories found: {sorted(vehicle_categories)}\\n\")\n\n    all_good = True\n    issues = []\n\n    # Check each vehicle category separately\n    for veh_cat in sorted(vehicle_categories):\n        # Filter rows for this vehicle category\n        mask = df_shares.index.str.endswith(f'_{veh_cat}')\n        df_veh = df_shares[mask]\n\n        print(f\"--- Checking {veh_cat} ({len(df_veh)} categories) ---\")\n\n        # Check sums for each column within this vehicle category\n        veh_issues = []\n        for col in df_veh.columns:\n            col_sum = df_veh[col].sum()\n\n            if abs(col_sum - 1.0) > tolerance:\n                all_good = False\n                veh_issues.append((col, col_sum))\n\n        if not veh_issues:\n            print(f\"  ‚úÖ All shares sum to 1.0 for {veh_cat}\")\n        else:\n            print(f\"  ‚ö†Ô∏è  {len(veh_issues)} columns don't sum to 1.0 for {veh_cat}:\")\n            for col, sum_val in veh_issues[:5]:  # Show first 5\n                print(f\"     {col}: {sum_val:.4f}\")\n            if len(veh_issues) > 5:\n                print(f\"     ... and {len(veh_issues) - 5} more\")\n            issues.extend([(veh_cat, col, sum_val) for col, sum_val in veh_issues])\n        print()\n\n    print(f\"{'='*60}\")\n    if all_good:\n        print(\"‚úÖ ALL VEHICLE CATEGORIES: Shares sum to 1.0 (within tolerance)\")\n    else:\n        print(f\"‚ö†Ô∏è  WARNING: {len(issues)} total column/vehicle combinations don't sum to 1.0\")\n\n    print(f\"\\nTotal columns: {len(df_shares.columns)}\")\n    print(f\"Total vehicle categories: {len(vehicle_categories)}\")\n    print(f\"Total combinations: {len(df_shares.columns) * len(vehicle_categories)}\")\n\n    # Return sums by vehicle category\n    return {veh_cat: df_shares[df_shares.index.str.endswith(f'_{veh_cat}')].sum(axis=0)\n            for veh_cat in sorted(vehicle_categories)}\n```\n:::\n\n\n## Setup BigQuery\n\n\n\n::: {#ccf85118 .cell execution_count=6}\n``` {.python .cell-code}\n# # Import global TDM functions from remote 'Resource' repo\n\n# Fetch and import BigQuery module\nresponse = fetch_github(\n    'https://raw.githubusercontent.com/WFRCAnalytics/Resources/refs/heads/master/2-Python/global-functions/BigQuery.py',\n    mode=\"public\"\n)\n\nBigQuery = importlib.util.module_from_spec(importlib.util.spec_from_loader('BigQuery', loader=None))\nexec(response.text, BigQuery.__dict__)\n\n# Initiatlize BigQuery Client\nclient = BigQuery.getBigQueryClient_Confidential2023UtahHTS()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\npukar.bhandari\nC:/Users/Pukar.Bhandari/.private/confidential-2023-utah-hts-5fd7ddd219a7.json\n```\n:::\n:::\n\n\n# Load Data\n\n## UTA On-Board Survey\n\n::: {#629a2b36 .cell execution_count=7}\n``` {.python .cell-code}\n# Read Linked UTA On-Board Survey Data directly from GitHub repo\nresponse = fetch_github(\n    \"https://raw.githubusercontent.com/WFRCAnalytics/DATA-OBS-Prep-For-TDM/refs/heads/main/_output/UTA_OBS_2024_Linked.csv\",\n    mode = \"private\"\n)\n\ndf_obs_linked = pd.read_csv(io.StringIO(response.text))\ndf_obs_linked\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nC:\\Users\\Pukar.Bhandari\\AppData\\Local\\Temp\\ipykernel_28008\\4156658631.py:7: DtypeWarning:\n\nColumns (8,24,32,37,54,132,137,174) have mixed types. Specify dtype option on import or set low_memory=False.\n\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=31}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>ID</th>\n      <th>DATE_COMPLETED</th>\n      <th>DATE_TYPE</th>\n      <th>ROUTE_DIRECTION_Code</th>\n      <th>ROUTE_DIRECTION</th>\n      <th>ROUTE_DIRECTION_Other</th>\n      <th>HOME_ADDRESS_CITY</th>\n      <th>HOME_ADDRESS_STATE</th>\n      <th>HOME_ADDRESS_ZIP</th>\n      <th>HOME_ADDRESS_LAT</th>\n      <th>...</th>\n      <th>p_Stop_lat</th>\n      <th>p_Stop_lon</th>\n      <th>a_Stop_lat</th>\n      <th>a_Stop_lon</th>\n      <th>p_Stop_N</th>\n      <th>a_Stop_N</th>\n      <th>access_dist</th>\n      <th>access_time</th>\n      <th>egress_dist</th>\n      <th>egress_time</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>5948</td>\n      <td>2/27/2024</td>\n      <td>Weekday</td>\n      <td>UTA_1_2_00</td>\n      <td>2 200 SOUTH - TO U HOSPITAL</td>\n      <td>NaN</td>\n      <td>Clearfield</td>\n      <td>UT</td>\n      <td>84015</td>\n      <td>41.119565</td>\n      <td>...</td>\n      <td>41.118979</td>\n      <td>-112.025922</td>\n      <td>40.769221</td>\n      <td>-111.898663</td>\n      <td>27702.0</td>\n      <td>25493.0</td>\n      <td>0.37</td>\n      <td>8.79</td>\n      <td>0.68</td>\n      <td>16.27</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>6067</td>\n      <td>2/27/2024</td>\n      <td>Weekday</td>\n      <td>UTA_1_47_00</td>\n      <td>47 4700 SOUTH - TO W VALLEY CTL</td>\n      <td>NaN</td>\n      <td>West Valley City</td>\n      <td>UT</td>\n      <td>84119</td>\n      <td>40.689590</td>\n      <td>...</td>\n      <td>40.689384</td>\n      <td>-111.967476</td>\n      <td>40.660941</td>\n      <td>-111.899443</td>\n      <td>23195.0</td>\n      <td>23685.0</td>\n      <td>0.56</td>\n      <td>13.53</td>\n      <td>0.24</td>\n      <td>5.70</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>6069</td>\n      <td>3/16/2024</td>\n      <td>Saturday</td>\n      <td>UTA_1_750_01</td>\n      <td>FRONTRUNNER 750 - SOUTHBOUND</td>\n      <td>NaN</td>\n      <td>Ogden</td>\n      <td>UT</td>\n      <td>84401</td>\n      <td>41.186697</td>\n      <td>...</td>\n      <td>41.188757</td>\n      <td>-112.039378</td>\n      <td>40.784356</td>\n      <td>-111.982117</td>\n      <td>10042.0</td>\n      <td>15093.0</td>\n      <td>1.15</td>\n      <td>2.76</td>\n      <td>0.20</td>\n      <td>4.89</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>6073</td>\n      <td>2/28/2024</td>\n      <td>Weekday</td>\n      <td>UTA_1_750_01</td>\n      <td>FRONTRUNNER 750 - SOUTHBOUND</td>\n      <td>NaN</td>\n      <td>Ogden</td>\n      <td>UT</td>\n      <td>84401</td>\n      <td>41.236749</td>\n      <td>...</td>\n      <td>41.188757</td>\n      <td>-112.039378</td>\n      <td>40.659758</td>\n      <td>-111.896432</td>\n      <td>10042.0</td>\n      <td>10016.0</td>\n      <td>4.17</td>\n      <td>8.22</td>\n      <td>1.37</td>\n      <td>3.29</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>6077</td>\n      <td>2/28/2024</td>\n      <td>Weekday</td>\n      <td>UTA_1_47_00</td>\n      <td>47 4700 SOUTH - TO W VALLEY CTL</td>\n      <td>NaN</td>\n      <td>West Valley City</td>\n      <td>UT</td>\n      <td>84119</td>\n      <td>40.669687</td>\n      <td>...</td>\n      <td>40.667711</td>\n      <td>-111.961123</td>\n      <td>40.681907</td>\n      <td>-112.024041</td>\n      <td>22922.0</td>\n      <td>22421.0</td>\n      <td>0.25</td>\n      <td>6.00</td>\n      <td>0.49</td>\n      <td>11.88</td>\n    </tr>\n    <tr>\n      <th>...</th>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n    </tr>\n    <tr>\n      <th>13790</th>\n      <td>30339</td>\n      <td>4/26/2024</td>\n      <td>Weekday</td>\n      <td>UTA_1_704_01</td>\n      <td>TRAX GREEN LINE 704 - TO AIRPORT</td>\n      <td>NaN</td>\n      <td>Salt Lake City</td>\n      <td>UT</td>\n      <td>84116</td>\n      <td>40.772420</td>\n      <td>...</td>\n      <td>40.771536</td>\n      <td>-111.945736</td>\n      <td>40.771502</td>\n      <td>-111.914486</td>\n      <td>15101.0</td>\n      <td>15122.0</td>\n      <td>0.31</td>\n      <td>7.53</td>\n      <td>0.17</td>\n      <td>4.07</td>\n    </tr>\n    <tr>\n      <th>13791</th>\n      <td>30340</td>\n      <td>4/26/2024</td>\n      <td>Weekday</td>\n      <td>UTA_1_704_00</td>\n      <td>TRAX GREEN LINE 704 - TO WEST VALLEY</td>\n      <td>NaN</td>\n      <td>Salt Lake City</td>\n      <td>UT</td>\n      <td>84116</td>\n      <td>40.771361</td>\n      <td>...</td>\n      <td>40.771505</td>\n      <td>-111.915361</td>\n      <td>40.750058</td>\n      <td>-111.896818</td>\n      <td>15122.0</td>\n      <td>15109.0</td>\n      <td>0.46</td>\n      <td>11.00</td>\n      <td>1.21</td>\n      <td>29.10</td>\n    </tr>\n    <tr>\n      <th>13792</th>\n      <td>30341</td>\n      <td>4/26/2024</td>\n      <td>Weekday</td>\n      <td>UTA_1_704_00</td>\n      <td>TRAX GREEN LINE 704 - TO WEST VALLEY</td>\n      <td>NaN</td>\n      <td>Salt Lake City</td>\n      <td>UT</td>\n      <td>84116</td>\n      <td>40.773232</td>\n      <td>...</td>\n      <td>40.771505</td>\n      <td>-111.915361</td>\n      <td>40.725345</td>\n      <td>-111.877499</td>\n      <td>15122.0</td>\n      <td>24968.0</td>\n      <td>0.17</td>\n      <td>4.07</td>\n      <td>0.86</td>\n      <td>20.68</td>\n    </tr>\n    <tr>\n      <th>13793</th>\n      <td>1000002</td>\n      <td>2/29/2024</td>\n      <td>Weekday</td>\n      <td>UTA_1_701_00</td>\n      <td>TRAX BLUE LINE 701 - TO DRAPER</td>\n      <td>NaN</td>\n      <td>Salt Lake City</td>\n      <td>UT</td>\n      <td>84111</td>\n      <td>40.751607</td>\n      <td>...</td>\n      <td>40.755113</td>\n      <td>-111.891095</td>\n      <td>40.674859</td>\n      <td>-111.943134</td>\n      <td>15123.0</td>\n      <td>23342.0</td>\n      <td>0.33</td>\n      <td>7.95</td>\n      <td>0.29</td>\n      <td>7.02</td>\n    </tr>\n    <tr>\n      <th>13794</th>\n      <td>1000004</td>\n      <td>2/29/2024</td>\n      <td>Weekday</td>\n      <td>UTA_1_701_00</td>\n      <td>TRAX BLUE LINE 701 - TO DRAPER</td>\n      <td>NaN</td>\n      <td>Salt Lake City</td>\n      <td>UT</td>\n      <td>84109</td>\n      <td>40.722068</td>\n      <td>...</td>\n      <td>40.725878</td>\n      <td>-111.830935</td>\n      <td>40.525496</td>\n      <td>-111.858805</td>\n      <td>25663.0</td>\n      <td>15041.0</td>\n      <td>0.79</td>\n      <td>18.85</td>\n      <td>0.19</td>\n      <td>4.44</td>\n    </tr>\n  </tbody>\n</table>\n<p>13795 rows √ó 303 columns</p>\n</div>\n```\n:::\n:::\n\n\n## Household Travel Survey\n\n::: {#1411056e .cell execution_count=8}\n``` {.python .cell-code}\n# Load Linked Trips data from 2023 Household Travel Survey\ndf_hts_linked = client.query(\n    \"SELECT hh_id, PURP7_t, depart_per, model_trip_mode_WFv10, trip_weight FROM \" + 'wfrc-modeling-data.prd_tdm_hts_2023.trip_linked'\n).to_dataframe()\n\ndf_hts_linked\n```\n\n::: {.cell-output .cell-output-display execution_count=32}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>hh_id</th>\n      <th>PURP7_t</th>\n      <th>depart_per</th>\n      <th>model_trip_mode_WFv10</th>\n      <th>trip_weight</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>23041058</td>\n      <td>HBC</td>\n      <td>AM</td>\n      <td>auto_occ2</td>\n      <td>38.667618</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>23089619</td>\n      <td>HBC</td>\n      <td>AM</td>\n      <td>auto_sov</td>\n      <td>249.670620</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>23004082</td>\n      <td>HBOth</td>\n      <td>AM</td>\n      <td>auto_sov</td>\n      <td>0.335684</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>23004082</td>\n      <td>HBOth</td>\n      <td>AM</td>\n      <td>auto_occ2</td>\n      <td>0.335684</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>23006036</td>\n      <td>HBOth</td>\n      <td>AM</td>\n      <td>drive-to-transit</td>\n      <td>192.779770</td>\n    </tr>\n    <tr>\n      <th>...</th>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n    </tr>\n    <tr>\n      <th>769</th>\n      <td>23468106</td>\n      <td>NHBW</td>\n      <td>PM</td>\n      <td>auto_sov</td>\n      <td>29.555339</td>\n    </tr>\n    <tr>\n      <th>770</th>\n      <td>23481219</td>\n      <td>NHBW</td>\n      <td>PM</td>\n      <td>auto_sov</td>\n      <td>0.000000</td>\n    </tr>\n    <tr>\n      <th>771</th>\n      <td>23485070</td>\n      <td>NHBW</td>\n      <td>PM</td>\n      <td>auto_sov</td>\n      <td>40.853892</td>\n    </tr>\n    <tr>\n      <th>772</th>\n      <td>23485704</td>\n      <td>NHBW</td>\n      <td>PM</td>\n      <td>bike</td>\n      <td>21.135348</td>\n    </tr>\n    <tr>\n      <th>773</th>\n      <td>23494181</td>\n      <td>NHBW</td>\n      <td>PM</td>\n      <td>auto_occ2</td>\n      <td>9.263474</td>\n    </tr>\n  </tbody>\n</table>\n<p>232451 rows √ó 5 columns</p>\n</div>\n```\n:::\n:::\n\n\n::: {#538f695e .cell execution_count=9}\n``` {.python .cell-code}\n# Load Household data from 2023 Household Travel Survey\ndf_hts_hh = client.query(\n    \"SELECT hh_id, num_vehicles_4cat FROM \" + 'wfrc-modeling-data.prd_tdm_hts_2023.hh'\n).to_dataframe()\n\ndf_hts_hh\n```\n\n::: {.cell-output .cell-output-display execution_count=33}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>hh_id</th>\n      <th>num_vehicles_4cat</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>23472690</td>\n      <td>3</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>23307416</td>\n      <td>3</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>23317145</td>\n      <td>2</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>23321176</td>\n      <td>2</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>23345703</td>\n      <td>2</td>\n    </tr>\n    <tr>\n      <th>...</th>\n      <td>...</td>\n      <td>...</td>\n    </tr>\n    <tr>\n      <th>11178</th>\n      <td>23165031</td>\n      <td>1</td>\n    </tr>\n    <tr>\n      <th>11179</th>\n      <td>23046966</td>\n      <td>1</td>\n    </tr>\n    <tr>\n      <th>11180</th>\n      <td>23043011</td>\n      <td>1</td>\n    </tr>\n    <tr>\n      <th>11181</th>\n      <td>23376736</td>\n      <td>1</td>\n    </tr>\n    <tr>\n      <th>11182</th>\n      <td>23085912</td>\n      <td>3</td>\n    </tr>\n  </tbody>\n</table>\n<p>11183 rows √ó 2 columns</p>\n</div>\n```\n:::\n:::\n\n\n# Understanding Mode Hierarchy\n\n```{mermaid}\nflowchart LR\n  T[\"üö¶ Total Trips\"]\n\n  %% Top-level split\n  T --> M[\"Motorized\"]\n  T --> NM[\"Non-motorized\"]\n\n  %% Motorized branch\n  subgraph S1[\"üöó Motorized Transportation\"]\n    direction TB\n    M --> A[\"Auto\"]\n    M --> TR[\"Transit\"]\n\n    %% Auto\n    A --> DA[\"Drive alone\"]\n    A --> SR[\"Shared ride\"]\n    SR --> SR2[\"SR2<br/><i>2 people</i>\"]\n    SR --> SR3[\"SR3<br/><i>3+ people</i>\"]\n\n    %% Transit (two complementary views)\n    subgraph S1a[\"üöå Transit ‚Äì By Service Type\"]\n      direction TB\n      TR --> TM[\"By service type\"]\n      TM --> LB[\"Local bus\"]\n      TM --> CB[\"Core bus\"]\n      TM --> EB[\"Express bus\"]\n      TM --> LRT[\"LRT<br/><i>light rail</i>\"]\n      TM --> CRT[\"CRT<br/><i>commuter rail</i>\"]\n      TM --> BRT[\"BRT<br/><i>bus rapid</i>\"]\n    end\n\n    subgraph S1b[\"üö∂üöó Transit ‚Äì By Access Type\"]\n      direction TB\n      TR --> TA[\"By access type\"]\n\n      %% Walk-to-transit\n      TA --> WTT[\"üö∂ Walk-to-transit\"]\n      WTT --> WLB[\"Walk ‚Üí Local bus\"]\n      WTT --> WCB[\"Walk ‚Üí Core bus\"]\n      WTT --> WEB[\"Walk ‚Üí Express bus\"]\n      WTT --> WLRT[\"Walk ‚Üí LRT\"]\n      WTT --> WCRT[\"Walk ‚Üí CRT\"]\n      WTT --> WBRT[\"Walk ‚Üí BRT\"]\n\n      %% Drive-to-transit\n      TA --> DTT[\"üöó Drive-to-transit\"]\n      DTT --> DLB[\"Drive ‚Üí Local bus\"]\n      DTT --> DCB[\"Drive ‚Üí Core bus\"]\n      DTT --> DEB[\"Drive ‚Üí Express bus\"]\n      DTT --> DLRT[\"Drive ‚Üí LRT\"]\n      DTT --> DCRT[\"Drive ‚Üí CRT\"]\n      DTT --> DBRT[\"Drive ‚Üí BRT\"]\n    end\n  end\n\n  %% Non-motorized branch\n  subgraph S2[\"üö∂ Non-motorized Transportation\"]\n    direction TB\n    NM --> WALK[\"Walk\"]\n    NM --> BIKE[\"Bike\"]\n  end\n\n  %% Styling\n  classDef rootNode fill:#2c3e50,stroke:#34495e,stroke-width:3px,color:#fff,font-weight:bold,font-size:16px\n  classDef motorizedNode fill:#3498db,stroke:#2980b9,stroke-width:2px,color:#fff,font-weight:bold\n  classDef nonMotorizedNode fill:#27ae60,stroke:#229954,stroke-width:2px,color:#fff,font-weight:bold\n  classDef autoNode fill:#e67e22,stroke:#d35400,stroke-width:2px,color:#fff\n  classDef transitNode fill:#9b59b6,stroke:#8e44ad,stroke-width:2px,color:#fff\n  classDef walkTransitNode fill:#1abc9c,stroke:#16a085,stroke-width:2px,color:#fff\n  classDef driveTransitNode fill:#e74c3c,stroke:#c0392b,stroke-width:2px,color:#fff\n  classDef leafNode fill:#ecf0f1,stroke:#95a5a6,stroke-width:1px,color:#2c3e50\n  classDef subgraphStyle fill:#f8f9fa,stroke:#dee2e6,stroke-width:2px\n\n  class T rootNode\n  class M motorizedNode\n  class NM nonMotorizedNode\n  class A,DA,SR,SR2,SR3 autoNode\n  class TR,TM,TA transitNode\n  class WTT,WLB,WCB,WEB,WLRT,WCRT,WBRT walkTransitNode\n  class DTT,DLB,DCB,DEB,DLRT,DCRT,DBRT driveTransitNode\n  class LB,CB,EB,LRT,CRT,BRT,WALK,BIKE leafNode\n```\n\n\n# Identify Variable of Interest\n\n## On-Board Survey\n\n::: {#5dae6aba .cell execution_count=10}\n``` {.python .cell-code}\ndf_obs_linked[[\n    \"Linked_Mode_txt\", # Linked Mode: MT = MicroTransit (dont need), LCL = local bus, COR = Core Bus, EXP = Express Bus, LRT = Light Rail Transit (TRAX), CRT = Commuter Rail Transit (FrontRunner), BRT = Bus Rapid Transit (OVX, UVX)\n    \"Purp5_text\", # Trip Purpose: HBW = Home-based Work, HBO = Home-based Other, HBC = Home-based College, NHB = Non-home based, HBSch = Home-based School\n    \"PK_OK\", # Peak vs OffPeak\n    \"Veh_Cat3p\", # Vehicle Ownership: 0 = 0 Vehicle Household, 1 = 1 Vehicle Household, 2 = 2 Vehicle Household, 3 = 3+ Vehicle Household\n    \"Mode_Fin\", # Current Mode: 1 = MT = MicroTransit (Dont need),  4 = LCL = local bus, 5 = COR = Core Bus, 6 = EXP = Express Bus, 7 = LRT = Light Rail Transit (TRAX), 8 = CRT = Commuter Rail Transit, 9 = BRT = Bus Rapid Transit (OVX, UVX)\n    \"Ac_Mode_Model\", # Access Mode to Transit: Walk (Walk to Transit), Drive (Drive to Transit)\n]]\n```\n:::\n\n\n# Process HTS to get needed vars\n\nOBS has already been processed in OBS Prep repo. So, this section will only Process HTS data to get needed columns.\n\n## Purpose (5-category)\n\n::: {#31dc38cd .cell execution_count=11}\n``` {.python .cell-code}\npurpose_mapping = {\n    'HBOth' : 'HBO',\n    'NHBNW' : 'NHB',\n    'HBW'   : 'HBW',\n    'NHBW'  : 'NHB',\n    'HBShp' : 'HBO',\n    'HBSch' : 'HBSch',\n    'HBC'   : 'HBC'\n}\n\ndf_hts_linked['Purp5_text'] = df_hts_linked['PURP7_t'].map(purpose_mapping)\n```\n:::\n\n\n## Vehicle Ownership\n\n::: {#09d65d07 .cell execution_count=12}\n``` {.python .cell-code}\n# Join household data to linked trips data\ndf_hts_linked = df_hts_linked.merge(\n    df_hts_hh.rename(columns={'num_vehicles_4cat': 'Veh_Cat3p'}),\n    on='hh_id',\n    how='left'  # Keep all trips, even if household data is missing\n)\n\n# Rename the vehicle ownership column to match the OBS data\ndf_hts_linked = df_hts_linked.rename(columns={'num_vehicles_4cat': 'Veh_Cat3p'})\n```\n:::\n\n\n## Peak - Offpeak\n\n::: {#91569eb7 .cell execution_count=13}\n``` {.python .cell-code}\ndf_hts_linked['PK_OK'] = np.where(\n    df_hts_linked[\"depart_per\"].isin([\"AM\", \"PM\"]),\n    \"PK\",\n    \"OK\"\n)\n```\n:::\n\n\n# Trips: Motorized vs Non-motorized\n\n::: {#623a018b .cell execution_count=14}\n``` {.python .cell-code}\n# 1. All Trips: Motorized vs Non-motorized\nprint(\"\\n\" + \"=\" * 60)\nprint(\"1. ALL TRIPS: MOTORIZED VS NON-MOTORIZED\")\nprint(\"=\" * 60)\n\nall_trips_mapping = {\n    'auto-sov'         : 'motor',\n    'auto-occ2'        : 'motor',\n    'auto-occ3p'       : 'motor',\n    'walk-to-transit'  : 'motor',\n    'drive-to-transit' : 'motor',\n    'walk'             : 'nonmotor',\n    'bike'             : 'nonmotor'\n}\n\ndf_alltrips_cat = calculate_categorical_shares(\n    df_hts_linked,\n    category_col='model_trip_mode_WFv10',\n    weight_col='trip_weight',\n    group_cols=['Veh_Cat3p', 'Purp5_text', 'PK_OK'],\n    filter_condition='model_trip_mode_WFv10 in [\"auto-sov\", \"auto-occ2\", \"auto-occ3p\", \"walk-to-transit\", \"drive-to-transit\", \"walk\", \"bike\"]',\n    category_mapping=all_trips_mapping,\n    prefix='calib_share'\n)\n\nprint(\"\\nShape:\", df_alltrips_cat.shape)\nprint(\"\\nFirst few rows:\")\nprint(df_alltrips_cat.head(10))\nprint(\"\\nVerification:\")\nverify_shares(df_alltrips_cat)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n============================================================\n1. ALL TRIPS: MOTORIZED VS NON-MOTORIZED\n============================================================\n\nShape: (10, 8)\n\nFirst few rows:\n                                HBO                 HBW                 NHB  \\\n                                 OK        PK        OK        PK        OK   \ncalib_share_motor_0veh     0.428027  0.435098  0.269699  0.395971  0.288723   \ncalib_share_motor_1veh     0.095625  0.161660  0.528675  0.497086  0.093941   \ncalib_share_motor_2veh     0.037979  0.053454  0.247089  0.378823  0.046970   \ncalib_share_motor_3veh     0.027963  0.028738  0.248695  0.437486  0.082083   \ncalib_share_motor_all      0.100259  0.105245  0.317311  0.429058  0.084532   \ncalib_share_nonmotor_0veh  0.571973  0.564902  0.730301  0.604029  0.711277   \ncalib_share_nonmotor_1veh  0.904375  0.838340  0.471325  0.502914  0.906059   \ncalib_share_nonmotor_2veh  0.962021  0.946546  0.752911  0.621177  0.953030   \ncalib_share_nonmotor_3veh  0.972037  0.971262  0.751305  0.562514  0.917917   \ncalib_share_nonmotor_all   0.899741  0.894755  0.682689  0.570942  0.915468   \n\n                                        HBSch       HBC  \n                                 PK     Daily     Daily  \ncalib_share_motor_0veh     0.350163  0.096161  0.094500  \ncalib_share_motor_1veh     0.077719  0.067156  0.289683  \ncalib_share_motor_2veh     0.078388  0.038911  0.308511  \ncalib_share_motor_3veh     0.103329  0.011767  0.304264  \ncalib_share_motor_all      0.100193  0.033239  0.255792  \ncalib_share_nonmotor_0veh  0.649837  0.903839  0.905500  \ncalib_share_nonmotor_1veh  0.922281  0.932844  0.710317  \ncalib_share_nonmotor_2veh  0.921612  0.961089  0.691489  \ncalib_share_nonmotor_3veh  0.896671  0.988233  0.695736  \ncalib_share_nonmotor_all   0.899807  0.966761  0.744208  \n\nVerification:\n=== Verifying Share Sums ===\n\nVehicle categories found: ['0veh', '1veh', '2veh', '3veh', 'all']\n\n--- Checking 0veh (2 categories) ---\n  ‚úÖ All shares sum to 1.0 for 0veh\n\n--- Checking 1veh (2 categories) ---\n  ‚úÖ All shares sum to 1.0 for 1veh\n\n--- Checking 2veh (2 categories) ---\n  ‚úÖ All shares sum to 1.0 for 2veh\n\n--- Checking 3veh (2 categories) ---\n  ‚úÖ All shares sum to 1.0 for 3veh\n\n--- Checking all (2 categories) ---\n  ‚úÖ All shares sum to 1.0 for all\n\n============================================================\n‚úÖ ALL VEHICLE CATEGORIES: Shares sum to 1.0 (within tolerance)\n\nTotal columns: 8\nTotal vehicle categories: 5\nTotal combinations: 40\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=37}\n```\n{'0veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBSch  Daily    1.0\n HBC    Daily    1.0\n dtype: float64,\n '1veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBSch  Daily    1.0\n HBC    Daily    1.0\n dtype: float64,\n '2veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBSch  Daily    1.0\n HBC    Daily    1.0\n dtype: float64,\n '3veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBSch  Daily    1.0\n HBC    Daily    1.0\n dtype: float64,\n 'all': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBSch  Daily    1.0\n HBC    Daily    1.0\n dtype: float64}\n```\n:::\n:::\n\n\n## Non-motorized Trips: Walk vs Bike\n\n::: {#44a5fa63 .cell execution_count=15}\n``` {.python .cell-code}\n# 2. NON-MOTORIZED TRIPS\nprint(\"\\n\" + \"=\" * 60)\nprint(\"2. NON-MOTORIZED TRIPS\")\nprint(\"=\" * 60)\n\n# non_motorized_mapping = {\n#     'walk' : 'walk',\n#     'bike' : 'bike'\n# }\n\ndf_nonmotorized_cat = calculate_categorical_shares(\n    df_hts_linked,\n    category_col='model_trip_mode_WFv10',\n    weight_col='trip_weight',\n    group_cols=['Veh_Cat3p', 'Purp5_text', 'PK_OK'],\n    filter_condition='model_trip_mode_WFv10 in [\"walk\", \"bike\"]',\n    category_mapping=None,\n    prefix='calib_share'\n)\n\nprint(\"\\nShape:\", df_nonmotorized_cat.shape)\nprint(\"\\nFirst few rows:\")\nprint(df_nonmotorized_cat.head(10))\nprint(\"\\nVerification:\")\nverify_shares(df_nonmotorized_cat)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n============================================================\n2. NON-MOTORIZED TRIPS\n============================================================\n\nShape: (10, 8)\n\nFirst few rows:\n                            HBO                 HBW                 NHB  \\\n                             OK        PK        OK        PK        OK   \ncalib_share_bike_0veh  0.093370  0.081922  0.126895  0.184947  0.096749   \ncalib_share_bike_1veh  0.141585  0.107295  0.225268  0.300143  0.100676   \ncalib_share_bike_2veh  0.104966  0.139940  0.338888  0.382897  0.076727   \ncalib_share_bike_3veh  0.131393  0.033276  0.110195  0.564415  0.056874   \ncalib_share_bike_all   0.117384  0.107575  0.215958  0.377379  0.076507   \ncalib_share_walk_0veh  0.906630  0.918078  0.873105  0.815053  0.903251   \ncalib_share_walk_1veh  0.858415  0.892705  0.774732  0.699857  0.899324   \ncalib_share_walk_2veh  0.895034  0.860060  0.661112  0.617103  0.923273   \ncalib_share_walk_3veh  0.868607  0.966724  0.889805  0.435585  0.943126   \ncalib_share_walk_all   0.882616  0.892425  0.784042  0.622621  0.923493   \n\n                                    HBSch       HBC  \n                             PK     Daily     Daily  \ncalib_share_bike_0veh  0.168994  0.023156  0.007745  \ncalib_share_bike_1veh  0.110790  0.135214  0.167210  \ncalib_share_bike_2veh  0.074370  0.107164  0.101549  \ncalib_share_bike_3veh  0.076972  0.103986  0.000000  \ncalib_share_bike_all   0.088079  0.107922  0.063449  \ncalib_share_walk_0veh  0.831006  0.976844  0.992255  \ncalib_share_walk_1veh  0.889210  0.864786  0.832790  \ncalib_share_walk_2veh  0.925630  0.892836  0.898451  \ncalib_share_walk_3veh  0.923028  0.896014  1.000000  \ncalib_share_walk_all   0.911921  0.892078  0.936551  \n\nVerification:\n=== Verifying Share Sums ===\n\nVehicle categories found: ['0veh', '1veh', '2veh', '3veh', 'all']\n\n--- Checking 0veh (2 categories) ---\n  ‚úÖ All shares sum to 1.0 for 0veh\n\n--- Checking 1veh (2 categories) ---\n  ‚úÖ All shares sum to 1.0 for 1veh\n\n--- Checking 2veh (2 categories) ---\n  ‚úÖ All shares sum to 1.0 for 2veh\n\n--- Checking 3veh (2 categories) ---\n  ‚úÖ All shares sum to 1.0 for 3veh\n\n--- Checking all (2 categories) ---\n  ‚úÖ All shares sum to 1.0 for all\n\n============================================================\n‚úÖ ALL VEHICLE CATEGORIES: Shares sum to 1.0 (within tolerance)\n\nTotal columns: 8\nTotal vehicle categories: 5\nTotal combinations: 40\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=38}\n```\n{'0veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBSch  Daily    1.0\n HBC    Daily    1.0\n dtype: float64,\n '1veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBSch  Daily    1.0\n HBC    Daily    1.0\n dtype: float64,\n '2veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBSch  Daily    1.0\n HBC    Daily    1.0\n dtype: float64,\n '3veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBSch  Daily    1.0\n HBC    Daily    1.0\n dtype: float64,\n 'all': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBSch  Daily    1.0\n HBC    Daily    1.0\n dtype: float64}\n```\n:::\n:::\n\n\n## Motorized Trips: Auto vs Transit\n\n::: {#59a3790e .cell execution_count=16}\n``` {.python .cell-code}\n# 3. Motorized Trips: Auto vs Transit\nprint(\"\\n\" + \"=\" * 60)\nprint(\"3. MOTORIZED TRIPS: AUTO VS TRANSIT\")\nprint(\"=\" * 60)\n\nmotorized_mapping = {\n    'auto-sov'         : 'auto',\n    'auto_occ2'        : 'auto',\n    'auto_occ3p'       : 'auto',\n    'walk-to-transit'  : 'transit',\n    'drive-to-transit' : 'transit'\n}\n\ndf_motorized_cat = calculate_categorical_shares(\n    df_hts_linked,\n    category_col='model_trip_mode_WFv10',\n    weight_col='trip_weight',\n    group_cols=['Veh_Cat3p', 'Purp5_text', 'PK_OK'],\n    filter_condition='model_trip_mode_WFv10 in [\"auto-sov\", \"auto_occ2\", \"auto_occ3p\", \"walk-to-transit\", \"drive-to-transit\"]',\n    category_mapping=motorized_mapping,\n    prefix='calib_share'\n)\n\nprint(\"\\nShape:\", df_motorized_cat.shape)\nprint(\"\\nFirst few rows:\")\nprint(df_motorized_cat.head(10))\nprint(\"\\nVerification:\")\nverify_shares(df_motorized_cat)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n============================================================\n3. MOTORIZED TRIPS: AUTO VS TRANSIT\n============================================================\n\nShape: (10, 8)\n\nFirst few rows:\n                               HBO                 HBW                 NHB  \\\n                                OK        PK        OK        PK        OK   \ncalib_share_auto_0veh     0.461486  0.699976  0.737624  0.565582  0.700697   \ncalib_share_auto_1veh     0.982298  0.966485  0.844695  0.820529  0.982598   \ncalib_share_auto_2veh     0.995405  0.993468  0.924967  0.894349  0.992702   \ncalib_share_auto_3veh     0.997980  0.998208  0.957457  0.913352  0.988281   \ncalib_share_auto_all      0.987124  0.987439  0.902172  0.872203  0.985916   \ncalib_share_transit_0veh  0.538514  0.300024  0.262376  0.434418  0.299303   \ncalib_share_transit_1veh  0.017702  0.033515  0.155305  0.179471  0.017402   \ncalib_share_transit_2veh  0.004595  0.006532  0.075033  0.105651  0.007298   \ncalib_share_transit_3veh  0.002020  0.001792  0.042543  0.086648  0.011719   \ncalib_share_transit_all   0.012876  0.012561  0.097828  0.127797  0.014084   \n\n                                         HBC     HBSch  \n                                PK     Daily     Daily  \ncalib_share_auto_0veh     0.595672  0.556326  0.383176  \ncalib_share_auto_1veh     0.983317  0.780460  0.977310  \ncalib_share_auto_2veh     0.989979  0.598645  0.989189  \ncalib_share_auto_3veh     0.989260  0.691264  0.997318  \ncalib_share_auto_all      0.985975  0.691810  0.991149  \ncalib_share_transit_0veh  0.404328  0.443674  0.616824  \ncalib_share_transit_1veh  0.016683  0.219540  0.022690  \ncalib_share_transit_2veh  0.010021  0.401355  0.010811  \ncalib_share_transit_3veh  0.010740  0.308736  0.002682  \ncalib_share_transit_all   0.014025  0.308190  0.008851  \n\nVerification:\n=== Verifying Share Sums ===\n\nVehicle categories found: ['0veh', '1veh', '2veh', '3veh', 'all']\n\n--- Checking 0veh (2 categories) ---\n  ‚úÖ All shares sum to 1.0 for 0veh\n\n--- Checking 1veh (2 categories) ---\n  ‚úÖ All shares sum to 1.0 for 1veh\n\n--- Checking 2veh (2 categories) ---\n  ‚úÖ All shares sum to 1.0 for 2veh\n\n--- Checking 3veh (2 categories) ---\n  ‚úÖ All shares sum to 1.0 for 3veh\n\n--- Checking all (2 categories) ---\n  ‚úÖ All shares sum to 1.0 for all\n\n============================================================\n‚úÖ ALL VEHICLE CATEGORIES: Shares sum to 1.0 (within tolerance)\n\nTotal columns: 8\nTotal vehicle categories: 5\nTotal combinations: 40\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=39}\n```\n{'0veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64,\n '1veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64,\n '2veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64,\n '3veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64,\n 'all': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64}\n```\n:::\n:::\n\n\n### Auto Trips: Drive Alone vs Shared Rides\n\n::: {#da68eb5f .cell execution_count=17}\n``` {.python .cell-code}\n# 4. Auto Trips: Drive Alone vs Shared Rides\nprint(\"\\n\" + \"=\" * 60)\nprint(\"4. AUTO TRIPS: DRIVE ALONE VS SHARED RIDES\")\nprint(\"=\" * 60)\n\nauto_ride_mapping = {\n    'auto-sov'   : 'alone',\n    'auto_occ2'  : 'shared',\n    'auto_occ3p' : 'shared'\n}\n\ndf_auto_riders = calculate_categorical_shares(\n    df_hts_linked,\n    category_col='model_trip_mode_WFv10',\n    weight_col='trip_weight',\n    group_cols=['Veh_Cat3p', 'Purp5_text', 'PK_OK'],\n    filter_condition='model_trip_mode_WFv10 in [\"auto-sov\", \"auto_occ2\", \"auto_occ3p\"]',\n    category_mapping=auto_ride_mapping,\n    prefix='calib_share'\n)\n\nprint(\"\\nShape:\", df_auto_riders.shape)\nprint(\"\\nFirst few rows:\")\nprint(df_auto_riders.head(10))\nprint(\"\\nVerification:\")\nverify_shares(df_auto_riders)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n============================================================\n4. AUTO TRIPS: DRIVE ALONE VS SHARED RIDES\n============================================================\n\nShape: (5, 8)\n\nFirst few rows:\n                         HBO       HBW       NHB        HBC HBSch\n                          OK   PK   OK   PK   OK   PK Daily Daily\ncalib_share_shared_0veh  1.0  1.0  1.0  1.0  1.0  1.0   1.0   1.0\ncalib_share_shared_1veh  1.0  1.0  1.0  1.0  1.0  1.0   1.0   1.0\ncalib_share_shared_2veh  1.0  1.0  1.0  1.0  1.0  1.0   1.0   1.0\ncalib_share_shared_3veh  1.0  1.0  1.0  1.0  1.0  1.0   1.0   1.0\ncalib_share_shared_all   1.0  1.0  1.0  1.0  1.0  1.0   1.0   1.0\n\nVerification:\n=== Verifying Share Sums ===\n\nVehicle categories found: ['0veh', '1veh', '2veh', '3veh', 'all']\n\n--- Checking 0veh (1 categories) ---\n  ‚úÖ All shares sum to 1.0 for 0veh\n\n--- Checking 1veh (1 categories) ---\n  ‚úÖ All shares sum to 1.0 for 1veh\n\n--- Checking 2veh (1 categories) ---\n  ‚úÖ All shares sum to 1.0 for 2veh\n\n--- Checking 3veh (1 categories) ---\n  ‚úÖ All shares sum to 1.0 for 3veh\n\n--- Checking all (1 categories) ---\n  ‚úÖ All shares sum to 1.0 for all\n\n============================================================\n‚úÖ ALL VEHICLE CATEGORIES: Shares sum to 1.0 (within tolerance)\n\nTotal columns: 8\nTotal vehicle categories: 5\nTotal combinations: 40\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=40}\n```\n{'0veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64,\n '1veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64,\n '2veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64,\n '3veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64,\n 'all': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64}\n```\n:::\n:::\n\n\n#### Shared Rides: 2 People vs 3+ People\n\n::: {#1d283787 .cell execution_count=18}\n``` {.python .cell-code}\n# 5. Shared Ride by the Number of People\nprint(\"\\n\" + \"=\" * 60)\nprint(\"5. SHARED RIDER BY NUMBER OF PEOPLE\")\nprint(\"=\" * 60)\n\nshared_ride_mapping = {\n    'auto_occ2' : 'sr2',\n    'auto_occ3p': 'sr3'\n}\n\ndf_shared_by_person = calculate_categorical_shares(\n    df_hts_linked,\n    category_col='model_trip_mode_WFv10',\n    weight_col='trip_weight',\n    group_cols=['Veh_Cat3p', 'Purp5_text', 'PK_OK'],\n    filter_condition='model_trip_mode_WFv10 in [\"auto_occ2\", \"auto_occ3p\"]',\n    category_mapping=shared_ride_mapping,\n    prefix='calib_share'\n)\n\nprint(\"\\nShape:\", df_shared_by_person.shape)\nprint(\"\\nFirst few rows:\")\nprint(df_shared_by_person.head(10))\nprint(\"\\nVerification:\")\nverify_shares(df_shared_by_person)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n============================================================\n5. SHARED RIDER BY NUMBER OF PEOPLE\n============================================================\n\nShape: (10, 8)\n\nFirst few rows:\n                           HBO                 HBW                 NHB  \\\n                            OK        PK        OK        PK        OK   \ncalib_share_sr2_0veh  0.709382  0.289280  0.731697  0.857568  0.740220   \ncalib_share_sr2_1veh  0.565882  0.518618  0.726008  0.795799  0.551582   \ncalib_share_sr2_2veh  0.512200  0.461630  0.792496  0.756507  0.458916   \ncalib_share_sr2_3veh  0.574960  0.531453  0.784871  0.702538  0.517496   \ncalib_share_sr2_all   0.543836  0.493188  0.770847  0.747774  0.498240   \ncalib_share_sr3_0veh  0.290618  0.710720  0.268303  0.142432  0.259780   \ncalib_share_sr3_1veh  0.434118  0.481382  0.273992  0.204201  0.448418   \ncalib_share_sr3_2veh  0.487800  0.538370  0.207504  0.243493  0.541084   \ncalib_share_sr3_3veh  0.425040  0.468547  0.215129  0.297462  0.482504   \ncalib_share_sr3_all   0.456164  0.506812  0.229153  0.252226  0.501760   \n\n                                     HBC     HBSch  \n                            PK     Daily     Daily  \ncalib_share_sr2_0veh  0.785824  0.950890  0.000000  \ncalib_share_sr2_1veh  0.509631  0.707841  0.308240  \ncalib_share_sr2_2veh  0.458682  0.968752  0.298725  \ncalib_share_sr2_3veh  0.493538  0.582443  0.437045  \ncalib_share_sr2_all   0.480974  0.733967  0.360179  \ncalib_share_sr3_0veh  0.214176  0.049110  1.000000  \ncalib_share_sr3_1veh  0.490369  0.292159  0.691760  \ncalib_share_sr3_2veh  0.541318  0.031248  0.701275  \ncalib_share_sr3_3veh  0.506462  0.417557  0.562955  \ncalib_share_sr3_all   0.519026  0.266033  0.639821  \n\nVerification:\n=== Verifying Share Sums ===\n\nVehicle categories found: ['0veh', '1veh', '2veh', '3veh', 'all']\n\n--- Checking 0veh (2 categories) ---\n  ‚úÖ All shares sum to 1.0 for 0veh\n\n--- Checking 1veh (2 categories) ---\n  ‚úÖ All shares sum to 1.0 for 1veh\n\n--- Checking 2veh (2 categories) ---\n  ‚úÖ All shares sum to 1.0 for 2veh\n\n--- Checking 3veh (2 categories) ---\n  ‚úÖ All shares sum to 1.0 for 3veh\n\n--- Checking all (2 categories) ---\n  ‚úÖ All shares sum to 1.0 for all\n\n============================================================\n‚úÖ ALL VEHICLE CATEGORIES: Shares sum to 1.0 (within tolerance)\n\nTotal columns: 8\nTotal vehicle categories: 5\nTotal combinations: 40\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=41}\n```\n{'0veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64,\n '1veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64,\n '2veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64,\n '3veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64,\n 'all': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64}\n```\n:::\n:::\n\n\n### Transit Trips: By Service and By Access Mode\n\n#### By Service Type\n\n::: {#3b3d7f9b .cell execution_count=19}\n``` {.python .cell-code}\n# 6. Transit by Service Type (within linked transit trips)\nprint(\"\\n\" + \"=\" * 60)\nprint(\"6. TRANSIT BY SERVICE TYPE\")\nprint(\"=\" * 60)\n\nservice_mapping = {\n    'LCL': 'local',\n    'COR': 'core',\n    'EXP': 'express',\n    'LRT': 'lrt',\n    'CRT': 'crt',\n    'BRT': 'brt'\n}\n\ndf_transit_by_service = calculate_categorical_shares(\n    df_obs_linked,\n    category_col='Linked_Mode_txt',\n    weight_col='LINKED_WEIGHT',\n    group_cols=['Veh_Cat3p', 'Purp5_text', 'PK_OK'],\n    filter_condition='Linked_Mode_txt != \"MT\"',\n    category_mapping=service_mapping,\n    prefix='calib_share'\n)\n\nprint(\"\\nShape:\", df_transit_by_service.shape)\nprint(\"\\nFirst few rows:\")\nprint(df_transit_by_service.head(10))\nprint(\"\\nVerification:\")\nverify_shares(df_transit_by_service)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n============================================================\n6. TRANSIT BY SERVICE TYPE\n============================================================\n\nShape: (25, 8)\n\nFirst few rows:\n                           HBO                 HBW                 NHB  \\\n                            OK        PK        OK        PK        OK   \ncalib_share_brt_0veh  0.093057  0.096456  0.047473  0.095224  0.153395   \ncalib_share_brt_1veh  0.089342  0.054748  0.046183  0.032496  0.148609   \ncalib_share_brt_2veh  0.048919  0.038212  0.028291  0.050144  0.219395   \ncalib_share_brt_3veh  0.069251  0.077194  0.045087  0.046860  0.183415   \ncalib_share_brt_all   0.079479  0.069215  0.042054  0.055455  0.169141   \ncalib_share_crt_0veh  0.050399  0.046084  0.062668  0.066167  0.032120   \ncalib_share_crt_1veh  0.108913  0.108609  0.131166  0.173338  0.079517   \ncalib_share_crt_2veh  0.162660  0.143757  0.185038  0.233631  0.073834   \ncalib_share_crt_3veh  0.188749  0.205590  0.257891  0.309838  0.055098   \ncalib_share_crt_all   0.107888  0.104278  0.144566  0.179742  0.055664   \n\n                                     HBC     HBSch  \n                            PK     Daily     Daily  \ncalib_share_brt_0veh  0.123222  0.270885  0.015133  \ncalib_share_brt_1veh  0.087382  0.280118  0.047447  \ncalib_share_brt_2veh  0.050852  0.191436  0.058813  \ncalib_share_brt_3veh  0.133186  0.237051  0.071987  \ncalib_share_brt_all   0.101817  0.243896  0.052479  \ncalib_share_crt_0veh  0.020874  0.077904  0.000000  \ncalib_share_crt_1veh  0.188967  0.133831  0.014499  \ncalib_share_crt_2veh  0.073795  0.193403  0.078049  \ncalib_share_crt_3veh  0.177490  0.217306  0.131698  \ncalib_share_crt_all   0.095124  0.161091  0.057136  \n\nVerification:\n=== Verifying Share Sums ===\n\nVehicle categories found: ['0veh', '1veh', '2veh', '3veh', 'all']\n\n--- Checking 0veh (5 categories) ---\n  ‚úÖ All shares sum to 1.0 for 0veh\n\n--- Checking 1veh (5 categories) ---\n  ‚úÖ All shares sum to 1.0 for 1veh\n\n--- Checking 2veh (5 categories) ---\n  ‚úÖ All shares sum to 1.0 for 2veh\n\n--- Checking 3veh (5 categories) ---\n  ‚úÖ All shares sum to 1.0 for 3veh\n\n--- Checking all (5 categories) ---\n  ‚úÖ All shares sum to 1.0 for all\n\n============================================================\n‚úÖ ALL VEHICLE CATEGORIES: Shares sum to 1.0 (within tolerance)\n\nTotal columns: 8\nTotal vehicle categories: 5\nTotal combinations: 40\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=42}\n```\n{'0veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64,\n '1veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64,\n '2veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64,\n '3veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64,\n 'all': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64}\n```\n:::\n:::\n\n\n#### By Access Mode: Walk vs Drive to Transit\n\n::: {#3e85616d .cell execution_count=20}\n``` {.python .cell-code}\n# 7. Transit by Access Type (Walk vs Drive) (within linked transit trips)\nprint(\"\\n\" + \"=\" * 60)\nprint(\"7. TRANSIT BY ACCESS TYPE\")\nprint(\"=\" * 60)\n\naccess_mapping = {\n    'Walk': 'walkacc',\n    'Drive': 'driveacc'\n}\n\ndf_transit_by_access = calculate_categorical_shares(\n    df_obs_linked,\n    category_col='Ac_Mode2_Model',\n    weight_col='LINKED_WEIGHT',\n    group_cols=['Veh_Cat3p', 'Purp5_text', 'PK_OK'],\n    filter_condition='Linked_Mode_txt != \"MT\"',\n    category_mapping=access_mapping,\n    prefix='calib_share'\n)\n\nprint(\"\\nShape:\", df_transit_by_access.shape)\nprint(\"\\nFirst few rows:\")\nprint(df_transit_by_access.head(10))\nprint(\"\\nVerification:\")\nverify_shares(df_transit_by_access)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n============================================================\n7. TRANSIT BY ACCESS TYPE\n============================================================\n\nShape: (10, 8)\n\nFirst few rows:\n                                HBO                 HBW                 NHB  \\\n                                 OK        PK        OK        PK        OK   \ncalib_share_driveacc_0veh  0.042043  0.041143  0.040632  0.044171  0.056313   \ncalib_share_driveacc_1veh  0.121467  0.141475  0.148949  0.206870  0.045113   \ncalib_share_driveacc_2veh  0.173299  0.202267  0.269593  0.365426  0.025015   \ncalib_share_driveacc_3veh  0.256207  0.246329  0.414853  0.422377  0.037477   \ncalib_share_driveacc_all   0.119140  0.129893  0.189060  0.235858  0.044757   \ncalib_share_walkacc_0veh   0.957957  0.958857  0.959368  0.955829  0.943687   \ncalib_share_walkacc_1veh   0.878533  0.858525  0.851051  0.793130  0.954887   \ncalib_share_walkacc_2veh   0.826701  0.797733  0.730407  0.634574  0.974985   \ncalib_share_walkacc_3veh   0.743793  0.753671  0.585147  0.577623  0.962523   \ncalib_share_walkacc_all    0.880860  0.870107  0.810940  0.764142  0.955243   \n\n                                          HBC     HBSch  \n                                 PK     Daily     Daily  \ncalib_share_driveacc_0veh  0.023835  0.034826  0.018714  \ncalib_share_driveacc_1veh  0.081784  0.216398  0.079303  \ncalib_share_driveacc_2veh  0.091050  0.353965  0.161519  \ncalib_share_driveacc_3veh  0.102363  0.524908  0.136143  \ncalib_share_driveacc_all   0.061683  0.300534  0.112939  \ncalib_share_walkacc_0veh   0.976165  0.965174  0.981286  \ncalib_share_walkacc_1veh   0.918216  0.783602  0.920697  \ncalib_share_walkacc_2veh   0.908950  0.646035  0.838481  \ncalib_share_walkacc_3veh   0.897637  0.475092  0.863857  \ncalib_share_walkacc_all    0.938317  0.699466  0.887061  \n\nVerification:\n=== Verifying Share Sums ===\n\nVehicle categories found: ['0veh', '1veh', '2veh', '3veh', 'all']\n\n--- Checking 0veh (2 categories) ---\n  ‚úÖ All shares sum to 1.0 for 0veh\n\n--- Checking 1veh (2 categories) ---\n  ‚úÖ All shares sum to 1.0 for 1veh\n\n--- Checking 2veh (2 categories) ---\n  ‚úÖ All shares sum to 1.0 for 2veh\n\n--- Checking 3veh (2 categories) ---\n  ‚úÖ All shares sum to 1.0 for 3veh\n\n--- Checking all (2 categories) ---\n  ‚úÖ All shares sum to 1.0 for all\n\n============================================================\n‚úÖ ALL VEHICLE CATEGORIES: Shares sum to 1.0 (within tolerance)\n\nTotal columns: 8\nTotal vehicle categories: 5\nTotal combinations: 40\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=43}\n```\n{'0veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64,\n '1veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64,\n '2veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64,\n '3veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64,\n 'all': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64}\n```\n:::\n:::\n\n\n##### Walk to Transit\n\n::: {#3561f267 .cell execution_count=21}\n``` {.python .cell-code}\n# 8. Walk-to-Transit by Service Type (within walk-to-transit trips)\nprint(\"\\n\" + \"=\" * 60)\nprint(\"8. WALK-TO-TRANSIT BY SERVICE TYPE\")\nprint(\"=\" * 60)\n\nwalk_service_mapping = {\n    'LCL': 'wlocal',\n    'EXP': 'wexpress',\n    'LRT': 'wlrt',\n    'CRT': 'wcrt',\n    'BRT': 'wbrt'\n}\n\ndf_walk_to_transit = calculate_categorical_shares(\n    df_obs_linked,\n    category_col='Linked_Mode_txt',\n    weight_col='LINKED_WEIGHT',\n    group_cols=['Veh_Cat3p', 'Purp5_text', 'PK_OK'],\n    filter_condition='Ac_Mode2_Model == \"Walk\" & Linked_Mode_txt != \"MT\"',\n    category_mapping=walk_service_mapping,\n    prefix='calib_share'\n)\n\n\nprint(\"\\nShape:\", df_walk_to_transit.shape)\nprint(\"\\nFirst few rows:\")\nprint(df_walk_to_transit.head(10))\nprint(\"\\nVerification:\")\nverify_shares(df_walk_to_transit)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n============================================================\n8. WALK-TO-TRANSIT BY SERVICE TYPE\n============================================================\n\nShape: (25, 8)\n\nFirst few rows:\n                            HBO                 HBW                 NHB  \\\n                             OK        PK        OK        PK        OK   \ncalib_share_wbrt_0veh  0.097142  0.100595  0.049484  0.099624  0.157465   \ncalib_share_wbrt_1veh  0.101694  0.063769  0.054266  0.039404  0.155630   \ncalib_share_wbrt_2veh  0.059173  0.047900  0.038733  0.060280  0.218994   \ncalib_share_wbrt_3veh  0.089317  0.096841  0.061895  0.081126  0.190556   \ncalib_share_wbrt_all   0.089796  0.079002  0.050130  0.067799  0.173773   \ncalib_share_wcrt_0veh  0.038325  0.033586  0.058874  0.056573  0.017703   \ncalib_share_wcrt_1veh  0.050163  0.047245  0.086122  0.089959  0.064832   \ncalib_share_wcrt_2veh  0.088223  0.059357  0.095408  0.089008  0.056101   \ncalib_share_wcrt_3veh  0.048907  0.077577  0.090973  0.180144  0.024711   \ncalib_share_wcrt_all   0.052514  0.047197  0.079453  0.087829  0.038608   \n\n                                      HBC     HBSch  \n                             PK     Daily     Daily  \ncalib_share_wbrt_0veh  0.126230  0.280659  0.015421  \ncalib_share_wbrt_1veh  0.095165  0.289213  0.025199  \ncalib_share_wbrt_2veh  0.055945  0.205743  0.062380  \ncalib_share_wbrt_3veh  0.148374  0.248898  0.083332  \ncalib_share_wbrt_all   0.108510  0.259711  0.047005  \ncalib_share_wcrt_0veh  0.021384  0.052249  0.000000  \ncalib_share_wcrt_1veh  0.149215  0.053229  0.002169  \ncalib_share_wcrt_2veh  0.051479  0.075014  0.019002  \ncalib_share_wcrt_3veh  0.123171  0.094045  0.009820  \ncalib_share_wcrt_all   0.072236  0.065616  0.009058  \n\nVerification:\n=== Verifying Share Sums ===\n\nVehicle categories found: ['0veh', '1veh', '2veh', '3veh', 'all']\n\n--- Checking 0veh (5 categories) ---\n  ‚úÖ All shares sum to 1.0 for 0veh\n\n--- Checking 1veh (5 categories) ---\n  ‚úÖ All shares sum to 1.0 for 1veh\n\n--- Checking 2veh (5 categories) ---\n  ‚úÖ All shares sum to 1.0 for 2veh\n\n--- Checking 3veh (5 categories) ---\n  ‚úÖ All shares sum to 1.0 for 3veh\n\n--- Checking all (5 categories) ---\n  ‚úÖ All shares sum to 1.0 for all\n\n============================================================\n‚úÖ ALL VEHICLE CATEGORIES: Shares sum to 1.0 (within tolerance)\n\nTotal columns: 8\nTotal vehicle categories: 5\nTotal combinations: 40\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=44}\n```\n{'0veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64,\n '1veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64,\n '2veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64,\n '3veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64,\n 'all': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n        PK       1.0\n HBC    Daily    1.0\n HBSch  Daily    1.0\n dtype: float64}\n```\n:::\n:::\n\n\n##### Drive to Transit\n\n::: {#1765caaf .cell execution_count=22}\n``` {.python .cell-code}\n# 9. Drive-to-Transit by Service Type (within drive-to-transit trips)\nprint(\"\\n\" + \"=\" * 60)\nprint(\"9. DRIVE-TO-TRANSIT BY SERVICE TYPE\")\nprint(\"=\" * 60)\n\ndrive_service_mapping = {\n    'LCL': 'dlocal',\n    'EXP': 'dexpress',\n    'LRT': 'dlrt',\n    'CRT': 'dcrt',\n    'BRT': 'dbrt'\n}\n\ndf_drive_to_transit = calculate_categorical_shares(\n    df_obs_linked,\n    category_col='Linked_Mode_txt',\n    weight_col='LINKED_WEIGHT',\n    group_cols=['Veh_Cat3p', 'Purp5_text', 'PK_OK'],\n    filter_condition='Ac_Mode2_Model == \"Drive\" & Linked_Mode_txt != \"MT\"',\n    category_mapping=drive_service_mapping,\n    prefix='calib_share'\n)\n\nprint(\"\\nShape:\", df_drive_to_transit.shape)\nprint(\"\\nFirst few rows:\")\nprint(df_drive_to_transit.head(10))\nprint(\"\\nVerification:\")\nverify_shares(df_drive_to_transit)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n============================================================\n9. DRIVE-TO-TRANSIT BY SERVICE TYPE\n============================================================\n\nShape: (24, 8)\n\nFirst few rows:\n                            HBO                 HBW                 NHB  \\\n                             OK        PK        OK        PK        OK   \ncalib_share_dbrt_0veh  0.000000  0.000000  0.000000  0.000000  0.085185   \ncalib_share_dbrt_1veh  0.000000  0.000000  0.000000  0.006011  0.000000   \ncalib_share_dbrt_2veh  0.000000  0.000000  0.000000  0.032543  0.235044   \ncalib_share_dbrt_3veh  0.010999  0.017082  0.021379  0.000000  0.000000   \ncalib_share_dbrt_all   0.003201  0.003659  0.007410  0.015461  0.070286   \ncalib_share_dcrt_0veh  0.325511  0.337345  0.152258  0.273792  0.273724   \ncalib_share_dcrt_1veh  0.533837  0.480993  0.388536  0.493010  0.390337   \ncalib_share_dcrt_2veh  0.517750  0.476627  0.427870  0.484774  0.764956   \ncalib_share_dcrt_3veh  0.594724  0.597261  0.493327  0.487201  0.835507   \ncalib_share_dcrt_all   0.517299  0.486644  0.423858  0.477524  0.419687   \n\n                            HBC       NHB     HBSch  \n                          Daily        PK     Daily  \ncalib_share_dbrt_0veh  0.000000  0.000000  0.000000  \ncalib_share_dbrt_1veh  0.247186  0.000000  0.305749  \ncalib_share_dbrt_2veh  0.165324  0.000000  0.040294  \ncalib_share_dbrt_3veh  0.226328  0.000000  0.000000  \ncalib_share_dbrt_all   0.207087  0.000000  0.095469  \ncalib_share_dcrt_0veh  0.788925  0.000000  0.000000  \ncalib_share_dcrt_1veh  0.425698  0.635278  0.157648  \ncalib_share_dcrt_2veh  0.409480  0.296569  0.384571  \ncalib_share_dcrt_3veh  0.328868  0.653824  0.905038  \ncalib_share_dcrt_all   0.383302  0.443292  0.434748  \n\nVerification:\n=== Verifying Share Sums ===\n\nVehicle categories found: ['0veh', '1veh', '2veh', '3veh', 'all']\n\n--- Checking 0veh (4 categories) ---\n  ‚úÖ All shares sum to 1.0 for 0veh\n\n--- Checking 1veh (5 categories) ---\n  ‚úÖ All shares sum to 1.0 for 1veh\n\n--- Checking 2veh (5 categories) ---\n  ‚úÖ All shares sum to 1.0 for 2veh\n\n--- Checking 3veh (5 categories) ---\n  ‚úÖ All shares sum to 1.0 for 3veh\n\n--- Checking all (5 categories) ---\n  ‚úÖ All shares sum to 1.0 for all\n\n============================================================\n‚úÖ ALL VEHICLE CATEGORIES: Shares sum to 1.0 (within tolerance)\n\nTotal columns: 8\nTotal vehicle categories: 5\nTotal combinations: 40\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=45}\n```\n{'0veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n HBC    Daily    1.0\n NHB    PK       1.0\n HBSch  Daily    1.0\n dtype: float64,\n '1veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n HBC    Daily    1.0\n NHB    PK       1.0\n HBSch  Daily    1.0\n dtype: float64,\n '2veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n HBC    Daily    1.0\n NHB    PK       1.0\n HBSch  Daily    1.0\n dtype: float64,\n '3veh': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n HBC    Daily    1.0\n NHB    PK       1.0\n HBSch  Daily    1.0\n dtype: float64,\n 'all': HBO    OK       1.0\n        PK       1.0\n HBW    OK       1.0\n        PK       1.0\n NHB    OK       1.0\n HBC    Daily    1.0\n NHB    PK       1.0\n HBSch  Daily    1.0\n dtype: float64}\n```\n:::\n:::\n\n\n# Export Calibration Target Files\n\n::: {#f0f057b0 .cell execution_count=23}\n``` {.python .cell-code}\nimport pandas as pd\nimport numpy as np\nimport plotly.graph_objects as go\nfrom plotly.subplots import make_subplots\n\n# Function to build hierarchical data for treemap\ndef build_treemap_data(\n    df_alltrips_cat,\n    df_nonmotorized_cat,\n    df_motorized_cat,\n    df_auto_riders,\n    df_shared_by_person,\n    df_transit_by_service,\n    df_transit_by_access,\n    df_walk_to_transit,\n    df_drive_to_transit,\n    purpose,\n    period,\n    veh_cat\n):\n    \"\"\"\n    Build hierarchical data structure for treemap from calibration dataframes.\n\n    Returns: labels, parents, values, colors, hover_text\n    \"\"\"\n\n    labels = []\n    parents = []\n    values = []\n    colors = []\n    hover_text = []\n\n    # Helper function to get value from dataframe\n    def get_value(df, pattern, purpose, period, veh_cat='all'):\n        \"\"\"Extract value from dataframe matching pattern and categories\"\"\"\n        try:\n            # Build the full variable name\n            if veh_cat == 'all':\n                var_name = f\"calib_share_{pattern}_all\"\n            else:\n                var_name = f\"calib_share_{pattern}_{veh_cat}\"\n\n            # Check if column exists\n            if (purpose, period) not in df.columns:\n                return 0.0\n\n            # Check if index exists\n            if var_name in df.index:\n                return df.loc[var_name, (purpose, period)]\n            else:\n                return 0.0\n        except:\n            return 0.0\n\n    # Color scheme\n    color_map = {\n        'Total': '#808080',\n        'Motorized': '#FFD700',\n        'Non-motorized': '#90EE90',\n        'Walk': '#228B22',\n        'Bike': '#32CD32',\n        'Auto': '#DC143C',\n        'Transit': '#4169E1',\n        'Drive Alone': '#8B0000',\n        'Shared Ride': '#CD5C5C',\n        'SR2': '#F08080',\n        'SR3': '#FFA07A',\n        'Local Bus': '#1E90FF',\n        'Core Bus': '#00BFFF',\n        'Express Bus': '#87CEEB',\n        'LRT': '#4682B4',\n        'CRT': '#5F9EA0',\n        'BRT': '#6495ED',\n        'Walk-to-Transit': '#00CED1',\n        'Drive-to-Transit': '#20B2AA',\n    }\n\n    # Root: Total Trips\n    labels.append('Total Trips')\n    parents.append('')\n    values.append(1.0)\n    colors.append(color_map['Total'])\n    hover_text.append(f\"<b>Total Trips</b><br>100.0%<br>{purpose} - {period}\")\n\n    # Level 1: Motorized vs Non-motorized\n    nonmotor_share = get_value(df_alltrips_cat, 'nonmotor', purpose, period, veh_cat)\n    motor_share = 1.0 - nonmotor_share\n\n    labels.append('Motorized')\n    parents.append('Total Trips')\n    values.append(motor_share)\n    colors.append(color_map['Motorized'])\n    hover_text.append(f\"<b>Motorized</b><br>{motor_share*100:.2f}%<br>of Total Trips\")\n\n    labels.append('Non-motorized')\n    parents.append('Total Trips')\n    values.append(nonmotor_share)\n    colors.append(color_map['Non-motorized'])\n    hover_text.append(f\"<b>Non-motorized</b><br>{nonmotor_share*100:.2f}%<br>of Total Trips\")\n\n    # Level 2a: Non-motorized ‚Üí Walk & Bike\n    walk_share = get_value(df_nonmotorized_cat, 'walk', purpose, period, veh_cat)\n    bike_share = get_value(df_nonmotorized_cat, 'bike', purpose, period, veh_cat)\n\n    labels.append('Walk')\n    parents.append('Non-motorized')\n    values.append(nonmotor_share * walk_share)\n    colors.append(color_map['Walk'])\n    hover_text.append(f\"<b>Walk</b><br>{walk_share*100:.2f}% of Non-motorized<br>{nonmotor_share*walk_share*100:.2f}% of Total\")\n\n    labels.append('Bike')\n    parents.append('Non-motorized')\n    values.append(nonmotor_share * bike_share)\n    colors.append(color_map['Bike'])\n    hover_text.append(f\"<b>Bike</b><br>{bike_share*100:.2f}% of Non-motorized<br>{nonmotor_share*bike_share*100:.2f}% of Total\")\n\n    # Level 2b: Motorized ‚Üí Auto & Transit\n    auto_share = get_value(df_motorized_cat, 'auto', purpose, period, veh_cat)\n    transit_share = get_value(df_motorized_cat, 'transit', purpose, period, veh_cat)\n\n    labels.append('Auto')\n    parents.append('Motorized')\n    values.append(motor_share * auto_share)\n    colors.append(color_map['Auto'])\n    hover_text.append(f\"<b>Auto</b><br>{auto_share*100:.2f}% of Motorized<br>{motor_share*auto_share*100:.2f}% of Total\")\n\n    labels.append('Transit')\n    parents.append('Motorized')\n    values.append(motor_share * transit_share)\n    colors.append(color_map['Transit'])\n    hover_text.append(f\"<b>Transit</b><br>{transit_share*100:.2f}% of Motorized<br>{motor_share*transit_share*100:.2f}% of Total\")\n\n    # Level 3a: Auto ‚Üí Drive Alone & Shared Ride\n    alone_share = get_value(df_auto_riders, 'alone', purpose, period, veh_cat)\n    shared_share = get_value(df_auto_riders, 'shared', purpose, period, veh_cat)\n    auto_absolute = motor_share * auto_share\n\n    labels.append('Drive Alone')\n    parents.append('Auto')\n    values.append(auto_absolute * alone_share)\n    colors.append(color_map['Drive Alone'])\n    hover_text.append(f\"<b>Drive Alone</b><br>{alone_share*100:.2f}% of Auto<br>{auto_absolute*alone_share*100:.2f}% of Total\")\n\n    labels.append('Shared Ride')\n    parents.append('Auto')\n    values.append(auto_absolute * shared_share)\n    colors.append(color_map['Shared Ride'])\n    hover_text.append(f\"<b>Shared Ride</b><br>{shared_share*100:.2f}% of Auto<br>{auto_absolute*shared_share*100:.2f}% of Total\")\n\n    # Level 4: Shared Ride ‚Üí SR2 & SR3\n    sr2_share = get_value(df_shared_by_person, 'sr2', purpose, period, veh_cat)\n    sr3_share = get_value(df_shared_by_person, 'sr3', purpose, period, veh_cat)\n    shared_absolute = auto_absolute * shared_share\n\n    labels.append('SR2')\n    parents.append('Shared Ride')\n    values.append(shared_absolute * sr2_share)\n    colors.append(color_map['SR2'])\n    hover_text.append(f\"<b>SR2 (2 people)</b><br>{sr2_share*100:.2f}% of Shared Ride<br>{shared_absolute*sr2_share*100:.2f}% of Total\")\n\n    labels.append('SR3')\n    parents.append('Shared Ride')\n    values.append(shared_absolute * sr3_share)\n    colors.append(color_map['SR3'])\n    hover_text.append(f\"<b>SR3 (3+ people)</b><br>{sr3_share*100:.2f}% of Shared Ride<br>{shared_absolute*sr3_share*100:.2f}% of Total\")\n\n    # Level 3b: Transit ‚Üí By Service Type\n    transit_absolute = motor_share * transit_share\n\n    service_types = ['local', 'core', 'brt', 'lrt', 'express', 'crt']\n    service_names = ['Local Bus', 'Core Bus', 'BRT', 'LRT', 'Express Bus', 'CRT']\n\n    for service, name in zip(service_types, service_names):\n        service_share = get_value(df_transit_by_service, service, purpose, period, veh_cat)\n        if service_share > 0:\n            labels.append(name)\n            parents.append('Transit')\n            values.append(transit_absolute * service_share)\n            colors.append(color_map.get(name, '#4169E1'))\n            hover_text.append(f\"<b>{name}</b><br>{service_share*100:.2f}% of Transit<br>{transit_absolute*service_share*100:.2f}% of Total\")\n\n    # Also add Transit by Access Mode as separate branches\n    walkacc_share = get_value(df_transit_by_access, 'walkacc', purpose, period, veh_cat)\n    driveacc_share = get_value(df_transit_by_access, 'driveacc', purpose, period, veh_cat)\n\n    if walkacc_share > 0:\n        labels.append('Walk-to-Transit')\n        parents.append('Transit')\n        values.append(transit_absolute * walkacc_share)\n        colors.append(color_map['Walk-to-Transit'])\n        hover_text.append(f\"<b>Walk-to-Transit</b><br>{walkacc_share*100:.2f}% of Transit<br>{transit_absolute*walkacc_share*100:.2f}% of Total\")\n\n        # Walk-to-Transit by service\n        walk_services = [('wlocal', 'W‚ÜíLocal'), ('wcore', 'W‚ÜíCore'), ('wbrt', 'W‚ÜíBRT'),\n                        ('wlrt', 'W‚ÜíLRT'), ('wexpress', 'W‚ÜíExpress'), ('wcrt', 'W‚ÜíCRT')]\n        walkacc_absolute = transit_absolute * walkacc_share\n\n        for service, name in walk_services:\n            service_share = get_value(df_walk_to_transit, service, purpose, period, veh_cat)\n            if service_share > 0:\n                labels.append(name)\n                parents.append('Walk-to-Transit')\n                values.append(walkacc_absolute * service_share)\n                colors.append('#48D1CC')\n                hover_text.append(f\"<b>{name}</b><br>{service_share*100:.2f}% of Walk-to-Transit<br>{walkacc_absolute*service_share*100:.2f}% of Total\")\n\n    if driveacc_share > 0:\n        labels.append('Drive-to-Transit')\n        parents.append('Transit')\n        values.append(transit_absolute * driveacc_share)\n        colors.append(color_map['Drive-to-Transit'])\n        hover_text.append(f\"<b>Drive-to-Transit</b><br>{driveacc_share*100:.2f}% of Transit<br>{transit_absolute*driveacc_share*100:.2f}% of Total\")\n\n        # Drive-to-Transit by service\n        drive_services = [('dlocal', 'D‚ÜíLocal'), ('dcore', 'D‚ÜíCore'), ('dbrt', 'D‚ÜíBRT'),\n                         ('dlrt', 'D‚ÜíLRT'), ('dexpress', 'D‚ÜíExpress'), ('dcrt', 'D‚ÜíCRT')]\n        driveacc_absolute = transit_absolute * driveacc_share\n\n        for service, name in drive_services:\n            service_share = get_value(df_drive_to_transit, service, purpose, period, veh_cat)\n            if service_share > 0:\n                labels.append(name)\n                parents.append('Drive-to-Transit')\n                values.append(driveacc_absolute * service_share)\n                colors.append('#3CB371')\n                hover_text.append(f\"<b>{name}</b><br>{service_share*100:.2f}% of Drive-to-Transit<br>{driveacc_absolute*service_share*100:.2f}% of Total\")\n\n    return labels, parents, values, colors, hover_text\n\n\n# Create the interactive figure with dropdowns\ndef create_interactive_treemap(\n    df_alltrips_cat,\n    df_nonmotorized_cat,\n    df_motorized_cat,\n    df_auto_riders,\n    df_shared_by_person,\n    df_transit_by_service,\n    df_transit_by_access,\n    df_walk_to_transit,\n    df_drive_to_transit\n):\n    \"\"\"\n    Create interactive treemap with dropdown menus for purpose, period, and vehicle category.\n    \"\"\"\n\n    # Extract available purposes and periods from the dataframes\n    purposes = sorted(set([col[0] for col in df_alltrips_cat.columns]))\n    periods = sorted(set([col[1] for col in df_alltrips_cat.columns]))\n\n    # Extract vehicle categories from index\n    veh_categories = ['all', '0veh', '1veh', '2veh', '3veh']\n\n    # Initialize with first combination\n    initial_purpose = purposes[0]\n    initial_period = periods[0]\n    initial_veh = 'all'\n\n    labels, parents, values, colors, hover_text = build_treemap_data(\n        df_alltrips_cat, df_nonmotorized_cat, df_motorized_cat,\n        df_auto_riders, df_shared_by_person, df_transit_by_service,\n        df_transit_by_access, df_walk_to_transit, df_drive_to_transit,\n        initial_purpose, initial_period, initial_veh\n    )\n\n    # Create figure\n    fig = go.Figure(go.Treemap(\n        labels=labels,\n        parents=parents,\n        values=values,\n        marker=dict(\n            colors=colors,\n            line=dict(width=2, color='white')\n        ),\n        text=hover_text,\n        hovertemplate='%{text}<extra></extra>',\n        textposition='middle center',\n        pathbar=dict(visible=True)\n    ))\n\n    # Create dropdown menus\n    buttons_purpose = []\n    for purpose in purposes:\n        buttons_purpose.append({\n            'label': purpose,\n            'method': 'skip',  # We'll handle updates via JavaScript callback\n            'args': [{'purpose': purpose}]\n        })\n\n    buttons_period = []\n    for period in periods:\n        buttons_period.append({\n            'label': period,\n            'method': 'skip',\n            'args': [{'period': period}]\n        })\n\n    buttons_veh = []\n    veh_labels = {\n        'all': 'All Vehicles',\n        '0veh': '0 Vehicles',\n        '1veh': '1 Vehicle',\n        '2veh': '2 Vehicles',\n        '3veh': '3+ Vehicles'\n    }\n    for veh in veh_categories:\n        buttons_veh.append({\n            'label': veh_labels[veh],\n            'method': 'skip',\n            'args': [{'veh_cat': veh}]\n        })\n\n    fig.update_layout(\n        title={\n            'text': f'Mode Choice Calibration Parameters<br><sub>{initial_purpose} - {initial_period} - {veh_labels[initial_veh]}</sub>',\n            'x': 0.5,\n            'xanchor': 'center',\n            'font': {'size': 20}\n        },\n        width=1400,\n        height=800,\n        font=dict(size=11),\n        updatemenus=[\n            # Purpose dropdown\n            dict(\n                buttons=[\n                    dict(label=p, method='restyle', args=[{'visible': True}])\n                    for p in purposes\n                ],\n                direction='down',\n                showactive=True,\n                x=0.17,\n                xanchor='left',\n                y=1.15,\n                yanchor='top',\n                bgcolor='white',\n                bordercolor='gray',\n                borderwidth=1\n            ),\n            # Period dropdown\n            dict(\n                buttons=[\n                    dict(label=p, method='restyle', args=[{'visible': True}])\n                    for p in periods\n                ],\n                direction='down',\n                showactive=True,\n                x=0.5,\n                xanchor='center',\n                y=1.15,\n                yanchor='top',\n                bgcolor='white',\n                bordercolor='gray',\n                borderwidth=1\n            ),\n            # Vehicle category dropdown\n            dict(\n                buttons=[\n                    dict(label=veh_labels[v], method='restyle', args=[{'visible': True}])\n                    for v in veh_categories\n                ],\n                direction='down',\n                showactive=True,\n                x=0.83,\n                xanchor='right',\n                y=1.15,\n                yanchor='top',\n                bgcolor='white',\n                bordercolor='gray',\n                borderwidth=1\n            )\n        ],\n        annotations=[\n            dict(text='<b>Purpose:</b>', x=0.02, y=1.13, xref='paper', yref='paper',\n                 showarrow=False, font=dict(size=12), xanchor='left'),\n            dict(text='<b>Period:</b>', x=0.38, y=1.13, xref='paper', yref='paper',\n                 showarrow=False, font=dict(size=12), xanchor='left'),\n            dict(text='<b>Vehicle Ownership:</b>', x=0.62, y=1.13, xref='paper', yref='paper',\n                 showarrow=False, font=dict(size=12), xanchor='left')\n        ]\n    )\n\n    return fig\n\n\n# Note: To use this code, call create_interactive_treemap with your dataframes:\nfig = create_interactive_treemap(\n    df_alltrips_cat, df_nonmotorized_cat, df_motorized_cat,\n    df_auto_riders, df_shared_by_person, df_transit_by_service,\n    df_transit_by_access, df_walk_to_transit, df_drive_to_transit\n)\nfig.show()\n```\n:::\n\n\n## Output Folder\n\n::: {#a1c03cf6 .cell execution_count=24}\n``` {.python .cell-code}\n# Create output directory if it doesn't exist\noutput_dir = Path(\"_output\")\noutput_dir.mkdir(parents=True, exist_ok=True)\n\nprint(\"=\" * 80)\nprint(\"EXPORTING CALIBRATION TARGET FILES\")\nprint(\"=\" * 80)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n================================================================================\nEXPORTING CALIBRATION TARGET FILES\n================================================================================\n```\n:::\n:::\n\n\n## Helper Functions\n\n### Extract Values\n\n::: {#fc805d1b .cell execution_count=25}\n``` {.python .cell-code}\ndef extract_values(df, purpose, period, pattern, include_veh_categories=True):\n    \"\"\"\n    Extract values from dataframe for given purpose/period matching a pattern.\n\n    Parameters:\n    -----------\n    df : DataFrame\n        DataFrame with MultiIndex columns (purpose, period)\n    purpose : str\n        Purpose to filter (e.g., 'HBW', 'HBO')\n    period : str\n        Period to filter (e.g., 'PK', 'OK', 'Daily')\n    pattern : str\n        Pattern to match in index (e.g., 'motor', 'bike', 'transit')\n    include_veh_categories : bool\n        If True, include all vehicle categories. If False, only include '_all' and strip suffix.\n\n    Returns:\n    --------\n    dict : {variable_name: value}\n    \"\"\"\n    results = {}\n\n    # Check if column exists\n    if (purpose, period) not in df.columns:\n        return results\n\n    # Filter rows matching pattern\n    mask = df.index.str.contains(pattern)\n\n    for idx in df[mask].index:\n        value = df.loc[idx, (purpose, period)]\n\n        if include_veh_categories:\n            # Include all vehicle categories as-is\n            results[idx] = value\n        else:\n            # Only include '_all' suffix and strip it\n            if idx.endswith('_all'):\n                # Remove '_all' suffix\n                var_name = idx.rsplit('_', 1)[0]\n                results[var_name] = value\n\n    return results\n```\n:::\n\n\n### Export Function\n\n::: {#1c73d5c4 .cell execution_count=26}\n``` {.python .cell-code}\ndef export_calib_file(purpose, period, include_veh_categories=True):\n    \"\"\"\n    Export calibration target file for a given purpose and period.\n\n    Parameters:\n    -----------\n    purpose : str\n        Trip purpose (HBW, HBO, NHB, HBC, HBSch)\n    period : str\n        Time period (PK, OK, Daily)\n    include_veh_categories : bool\n        If True, include vehicle category breakdowns (_0veh, _1veh, etc.)\n        If False, only use aggregate values without vehicle suffix\n    \"\"\"\n\n    # Determine file period (Daily becomes 'pk' for HBC/HBSch)\n    file_period = 'pk' if period == 'Daily' else period.lower()\n\n    # Determine display period for header\n    display_period = file_period.capitalize()\n    # display_period = 'Pk' if period == 'PK' or period == 'Daily' else 'Ok'\n\n    filename = f\"calib_target_{purpose.lower()}_{file_period}.txt\"\n    filepath = os.path.join(output_dir, filename)\n\n    print(f\"\\nCreating {filename}... (Vehicle categories: {'Yes' if include_veh_categories else 'No'})\")\n\n    with open(filepath, 'w') as f:\n        # Write header\n        f.write(f\";Calibration target values - {purpose} {display_period}\\t\\t\\n\")\n        f.write(\"\\t\\t\\n\")\n\n        # Write disclaimer\n        f.write(f\";Note: Not all of the variables listed below are used directly in the Mode Choice model. Some are included solely for verification and cross-checking purposes.\\t\\t\\n\")\n        f.write(\"\\t\\t\\n\")\n\n        # =====================================================================\n        # SECTION 1: Motorized vs Non-motorized (within total trips)\n        # =====================================================================\n        f.write(\";relative within total trips\\t\\t\\n\")\n\n        # Non-motorized shares only\n        nonmotorized = extract_values(df_alltrips_cat, purpose, period, 'nonmotor_', include_veh_categories)\n        if nonmotorized:\n            f.write(\"  ;nonmotorized shares \\t\\t\\n\")\n            for var, val in sorted(nonmotorized.items()):\n                f.write(f\"  {var:<30}\\t=\\t{val:.4f}\\n\")\n\n        f.write(\"\\t\\t\\n\")\n        f.write(\"\\t\\t\\n\")\n\n        # =====================================================================\n        # SECTION 2: Walk vs Bike (within nonmotorized)\n        # =====================================================================\n        f.write(\";relative within nonmotorized\\t\\t\\n\")\n\n        # Walk shares\n        walk = extract_values(df_nonmotorized_cat, purpose, period, 'walk_', include_veh_categories)\n        if walk:\n            f.write(\"  ;walk shares \\t\\t\\n\")\n            for var, val in sorted(walk.items()):\n                f.write(f\"  {var:<30}\\t=\\t{val:.4f}\\n\")\n            f.write(\"\\t\\t\\n\")\n\n        # Bike shares\n        bike = extract_values(df_nonmotorized_cat, purpose, period, 'bike_', include_veh_categories)\n        if bike:\n            f.write(\"  ;bike shares \\t\\t\\n\")\n            for var, val in sorted(bike.items()):\n                f.write(f\"  {var:<30}\\t=\\t{val:.4f}\\n\")\n\n        f.write(\"\\t\\t\\n\")\n        f.write(\"\\t\\t\\n\")\n\n        # =====================================================================\n        # SECTION 3: Drive Alone vs Shared Ride (within auto)\n        # =====================================================================\n        f.write(\";relative within auto\\t\\t\\n\")\n\n        # Drive alone shares\n        alone = extract_values(df_auto_riders, purpose, period, 'alone_', include_veh_categories)\n        if alone:\n            f.write(\"  ;drive alone shares \\t\\t\\n\")\n            for var, val in sorted(alone.items()):\n                f.write(f\"  {var:<30}\\t=\\t{val:.4f}\\n\")\n            f.write(\"\\t\\t\\n\")\n\n        # Shared ride shares\n        shared = extract_values(df_auto_riders, purpose, period, 'shared_', include_veh_categories)\n        if shared:\n            f.write(\"  ;shared ride shares \\t\\t\\n\")\n            for var, val in sorted(shared.items()):\n                f.write(f\"  {var:<30}\\t=\\t{val:.4f}\\n\")\n\n        f.write(\"\\t\\t\\n\")\n        f.write(\"\\t\\t\\n\")\n\n        # =====================================================================\n        # SECTION 4: SR2 vs SR3 (within shared ride)\n        # =====================================================================\n        f.write(\";relative within shared ride\\t\\t\\n\")\n\n        # SR2 shares\n        sr2 = extract_values(df_shared_by_person, purpose, period, 'sr2_', include_veh_categories)\n        if sr2:\n            f.write(\"  ;sr2 shares \\t\\t\\n\")\n            for var, val in sorted(sr2.items()):\n                f.write(f\"  {var:<30}\\t=\\t{val:.4f}\\n\")\n            f.write(\"\\t\\t\\n\")\n\n        # SR3 shares\n        sr3 = extract_values(df_shared_by_person, purpose, period, 'sr3_', include_veh_categories)\n        if sr3:\n            f.write(\"  ;sr3 shares \\t\\t\\n\")\n            for var, val in sorted(sr3.items()):\n                f.write(f\"  {var:<30}\\t=\\t{val:.4f}\\n\")\n\n        f.write(\"\\t\\t\\n\")\n        f.write(\"\\t\\t\\n\")\n\n        # =====================================================================\n        # SECTION 5: Auto vs Transit (within motorized)\n        # =====================================================================\n        f.write(\";relative within motorized\\t\\t\\n\")\n\n        # Auto shares\n        auto = extract_values(df_motorized_cat, purpose, period, 'auto_', include_veh_categories)\n        if auto:\n            f.write(\"  ;auto shares \\t\\t\\n\")\n            for var, val in sorted(auto.items()):\n                f.write(f\"  {var:<30}\\t=\\t{val:.4f}\\n\")\n            f.write(\"\\t\\t\\n\")\n\n        # Transit shares\n        transit = extract_values(df_motorized_cat, purpose, period, 'transit_', include_veh_categories)\n        if transit:\n            f.write(\"  ;transit shares \\t\\t\\n\")\n            for var, val in sorted(transit.items()):\n                f.write(f\"  {var:<30}\\t=\\t{val:.4f}\\n\")\n            f.write(\" \\t\\t\\n\")\n\n        f.write(\"\\t\\t\\n\")\n\n        # =====================================================================\n        # SECTION 6: Transit by Service Type (within transit)\n        # =====================================================================\n        f.write(\";relative within transit\\t\\t\\n\")\n\n        # Get all transit service types\n        service_types = ['local', 'core', 'brt', 'lrt', 'express', 'crt']\n        transit_services = {}\n        for service in service_types:\n            vals = extract_values(df_transit_by_service, purpose, period, f'{service}_', include_veh_categories)\n            transit_services.update(vals)\n\n        if transit_services:\n            for var, val in sorted(transit_services.items()):\n                f.write(f\"  {var:<30}\\t=\\t{val:.4f}\\n\")\n            f.write(\"  \\t\\t\\n\")\n\n        f.write(\"\\t\\t\\n\")\n\n        # =====================================================================\n        # SECTION 7: Walk vs Drive Access (within transit)\n        # =====================================================================\n        f.write(\";relative within transit\\t\\t\\n\")\n\n        # Walk access shares\n        walkacc = extract_values(df_transit_by_access, purpose, period, 'walkacc_', include_veh_categories)\n        if walkacc:\n            f.write(\"  ;walk-to-transit shares \\t\\t\\n\")\n            for var, val in sorted(walkacc.items()):\n                f.write(f\"  {var:<30}\\t=\\t{val:.4f}\\n\")\n            f.write(\"\\t\\t\\n\")\n\n        # Drive access shares\n        driveacc = extract_values(df_transit_by_access, purpose, period, 'driveacc_', include_veh_categories)\n        if driveacc:\n            f.write(\"  ;drive-to-transit shares \\t\\t\\n\")\n            for var, val in sorted(driveacc.items()):\n                f.write(f\"  {var:<30}\\t=\\t{val:.4f}\\n\")\n\n        f.write(\"\\t\\t\\n\")\n        f.write(\"\\t\\t\\n\")\n\n        # =====================================================================\n        # SECTION 8: Walk-to-Transit by Service (within walkacc)\n        # =====================================================================\n        f.write(\";relative within walkacc\\t\\t\\n\")\n\n        # Get all walk-to-transit service types\n        walk_services = {}\n        for service in ['wlocal', 'wcore', 'wbrt', 'wlrt', 'wexpress', 'wcrt']:\n            vals = extract_values(df_walk_to_transit, purpose, period, f'{service}_', include_veh_categories)\n            walk_services.update(vals)\n\n        if walk_services:\n            for var, val in sorted(walk_services.items()):\n                f.write(f\"  {var:<30}\\t=\\t{val:.4f}\\n\")\n\n        f.write(\"\\t\\t\\n\")\n        f.write(\"\\t\\t\\n\")\n\n        # =====================================================================\n        # SECTION 9: Drive-to-Transit by Service (within driveacc)\n        # =====================================================================\n        f.write(\";relative within driveacc\\t\\t\\n\")\n\n        # Get all drive-to-transit service types\n        drive_services = {}\n        for service in ['dlocal', 'dcore', 'dbrt', 'dlrt', 'dexpress', 'dcrt']:\n            vals = extract_values(df_drive_to_transit, purpose, period, f'{service}_', include_veh_categories)\n            drive_services.update(vals)\n\n        if drive_services:\n            for var, val in sorted(drive_services.items()):\n                f.write(f\"  {var:<30}\\t=\\t{val:.4f}\\n\")\n\n    print(f\"  ‚úÖ Written to {filepath}\")\n```\n:::\n\n\n## Export All Files\n\n::: {#74865c19 .cell execution_count=27}\n``` {.python .cell-code}\n# Define purposes and their configuration\nexport_config = {\n    'HBW':   {'periods': ['PK', 'OK'], 'include_veh': True},\n    'HBO':   {'periods': ['PK', 'OK'], 'include_veh': True},\n    'NHB':   {'periods': ['PK', 'OK'], 'include_veh': True}, # False\n    'HBC':   {'periods': ['Daily'],    'include_veh': True}, # False\n    'HBSch': {'periods': ['Daily'],    'include_veh': True}  # False\n}\n\nfor purpose, config in export_config.items():\n    for period in config['periods']:\n        export_calib_file(purpose, period, include_veh_categories=config['include_veh'])\n\nprint(\"\\n\" + \"=\" * 80)\nprint(\"‚úÖ EXPORT COMPLETE!\")\nprint(\"=\" * 80)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCreating calib_target_hbw_pk.txt... (Vehicle categories: Yes)\n  ‚úÖ Written to _output\\calib_target_hbw_pk.txt\n\nCreating calib_target_hbw_ok.txt... (Vehicle categories: Yes)\n  ‚úÖ Written to _output\\calib_target_hbw_ok.txt\n\nCreating calib_target_hbo_pk.txt... (Vehicle categories: Yes)\n  ‚úÖ Written to _output\\calib_target_hbo_pk.txt\n\nCreating calib_target_hbo_ok.txt... (Vehicle categories: Yes)\n  ‚úÖ Written to _output\\calib_target_hbo_ok.txt\n\nCreating calib_target_nhb_pk.txt... (Vehicle categories: Yes)\n  ‚úÖ Written to _output\\calib_target_nhb_pk.txt\n\nCreating calib_target_nhb_ok.txt... (Vehicle categories: Yes)\n  ‚úÖ Written to _output\\calib_target_nhb_ok.txt\n\nCreating calib_target_hbc_pk.txt... (Vehicle categories: Yes)\n  ‚úÖ Written to _output\\calib_target_hbc_pk.txt\n\nCreating calib_target_hbsch_pk.txt... (Vehicle categories: Yes)\n  ‚úÖ Written to _output\\calib_target_hbsch_pk.txt\n\n================================================================================\n‚úÖ EXPORT COMPLETE!\n================================================================================\n```\n:::\n:::\n\n\n",
    "supporting": [
      "index_files\\figure-html"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js\" integrity=\"sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js\" integrity=\"sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}