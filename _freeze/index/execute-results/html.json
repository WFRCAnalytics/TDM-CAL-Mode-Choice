{
  "hash": "29939642cfd9821a309479c81e52a9b3",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: Calculating the Mode Choice Calibration Parameters\nsubtitle: Using Household Travel Survey and UTA On-Board Survey Data\ndescription: Lorem Ipsum\nauthor:\n - name: Pukar Bhandari\n   email: pukar.bhandari@wfrc.utah.gov\n   affiliation:\n     - name: Wasatch Front Regional Council\n       url: \"https://wfrc.utah.gov/\"\ndate: \"2025-11-03\"\n---\n\n# Setup Environment\n\nThis section prepares the Python environment with all necessary libraries and configurations. We'll import data manipulation libraries (pandas, numpy), and visualization tools (matplotlib, seaborn).\n\n## Install Libraries\n\n```python\n!conda install -c conda-forge numpy pandas matplotlib seaborn requests pathlib BigQuery\n```\n\n## Import Libraries\n\n::: {#25212e9b .cell execution_count=1}\n``` {.python .cell-code}\nimport pandas as pd\nimport numpy as np\nimport matplotlib.pyplot as plt\nimport seaborn as sns\n\nimport importlib.util\nfrom pathlib import Path\nimport sys\nimport os\nimport requests\nimport io\n\nfrom dotenv import load_dotenv\nload_dotenv()\n```\n\n::: {.cell-output .cell-output-display execution_count=1}\n```\nTrue\n```\n:::\n:::\n\n\n## Environment Variables\n\n\n\n## Helper Functions\n\n::: {#d84faef1 .cell execution_count=2}\n``` {.python .cell-code}\ndef fetch_github(\n    url: str,\n    mode: str = \"private\",\n    token_env_var: str = \"GITHUB_TOKEN\"\n) -> requests.Response:\n    \"\"\"\n    Fetch content from GitHub repositories.\n\n    Args:\n        url: GitHub raw URL (e.g., https://raw.githubusercontent.com/...)\n        mode: \"public\" for public repos, \"private\" for private repos requiring authentication\n        token_env_var: Name of environment variable containing GitHub token (default: GITHUB_TOKEN)\n\n    Returns:\n        requests.Response object\n\n    Raises:\n        ValueError: If token is missing for private mode or invalid mode\n        requests.HTTPError: If request fails\n    \"\"\"\n    # Validate mode\n    if mode not in [\"public\", \"private\"]:\n        raise ValueError(f\"mode must be 'public' or 'private', got '{mode}'\")\n\n    if mode == \"public\":\n        response = requests.get(url, timeout=30)\n    else:\n        token = os.getenv(token_env_var)\n        if not token:\n            raise ValueError(\n                f\"GitHub token not found in environment variable '{token_env_var}'. \"\n                f\"Check your .env file has: {token_env_var}=your_token_here\"\n            )\n\n        headers = {\n            'Authorization': f'token {token}',\n            'Accept': 'application/vnd.github.v3.raw'\n        }\n        response = requests.get(url, headers=headers, timeout=30)\n\n    response.raise_for_status()\n    return response\n```\n:::\n\n\n::: {#a6fdfb27 .cell execution_count=3}\n``` {.python .cell-code}\ndef calculate_categorical_shares(\n    df,\n    category_col,\n    weight_col='LINKED_WEIGHT',\n    group_cols=['Veh_Cat3p', 'Purp5_text', 'PK_OK'],\n    filter_condition=None,\n    category_mapping=None,\n    prefix='share',\n    exclude_daily_purposes=['HBW', 'HBO', 'NHB']  # Only HBC and HBSch get daily\n):\n    \"\"\"\n    Calculate weighted shares of categories within groups, ensuring they sum to 1.\n\n    Parameters:\n    -----------\n    df : DataFrame\n        Input dataframe\n    category_col : str\n        Column containing the categories to calculate shares for\n    weight_col : str\n        Column containing weights for each observation\n    group_cols : list\n        Columns to group by (e.g., vehicle ownership, purpose, peak/off-peak)\n    filter_condition : str or None\n        Optional pandas query string to filter data before calculation\n    category_mapping : dict or None\n        Optional mapping to rename/recode categories\n    prefix : str\n        Prefix for output column names\n    exclude_daily_purposes : list\n        Purposes that should NOT get daily aggregates (only peak/off-peak)\n\n    Returns:\n    --------\n    DataFrame with shares in wide format\n    \"\"\"\n\n    # Start with a copy\n    df_work = df.copy()\n\n    # Apply filter if provided\n    if filter_condition:\n        df_work = df_work.query(filter_condition)\n\n    # Apply category mapping if provided\n    if category_mapping:\n        df_work[category_col] = df_work[category_col].map(category_mapping)\n        # Remove unmapped values\n        df_work = df_work.dropna(subset=[category_col])\n\n    # Remove any NaN values in key columns\n    df_work = df_work.dropna(subset=[category_col, weight_col] + group_cols)\n\n    # Initialize results dictionary\n    results = {}\n\n    # Calculate weighted shares for each group combination\n    for veh in sorted(df_work['Veh_Cat3p'].unique()):\n        for purpose in sorted(df_work['Purp5_text'].unique()):\n            for peak in sorted(df_work['PK_OK'].unique()):\n                subset = df_work.query(\n                    f\"Veh_Cat3p == '{veh}' & Purp5_text == '{purpose}' & PK_OK == '{peak}'\"\n                )\n\n                if len(subset) > 0:\n                    # Calculate weighted counts by category\n                    weighted_counts = subset.groupby(category_col)[weight_col].sum()\n                    total_weight = subset[weight_col].sum()\n\n                    for cat, weighted_count in weighted_counts.items():\n                        var_name = f\"{prefix}_{cat}_{veh}veh\"\n                        if var_name not in results:\n                            results[var_name] = {}\n                        results[var_name][(purpose, peak)] = weighted_count / total_weight\n\n    # Calculate \"_all\" aggregates (across all vehicle categories)\n    for purpose in sorted(df_work['Purp5_text'].unique()):\n        for peak in sorted(df_work['PK_OK'].unique()):\n            subset = df_work.query(f\"Purp5_text == '{purpose}' & PK_OK == '{peak}'\")\n\n            if len(subset) > 0:\n                weighted_counts = subset.groupby(category_col)[weight_col].sum()\n                total_weight = subset[weight_col].sum()\n\n                for cat, weighted_count in weighted_counts.items():\n                    var_name = f\"{prefix}_{cat}_all\"\n                    if var_name not in results:\n                        results[var_name] = {}\n                    results[var_name][(purpose, peak)] = weighted_count / total_weight\n\n    # Calculate daily aggregates for HBC and HBSch only\n    daily_purposes = [p for p in df_work['Purp5_text'].unique()\n                     if p not in exclude_daily_purposes]\n\n    for purpose in daily_purposes:\n        subset = df_work.query(f\"Purp5_text == '{purpose}'\")\n\n        if len(subset) > 0:\n            # For each vehicle category\n            for veh in sorted(df_work['Veh_Cat3p'].unique()):\n                veh_subset = subset.query(f\"Veh_Cat3p == '{veh}'\")\n                if len(veh_subset) > 0:\n                    weighted_counts = veh_subset.groupby(category_col)[weight_col].sum()\n                    total_weight = veh_subset[weight_col].sum()\n\n                    for cat, weighted_count in weighted_counts.items():\n                        var_name = f\"{prefix}_{cat}_{veh}veh\"\n                        if var_name not in results:\n                            results[var_name] = {}\n                        results[var_name][(purpose, 'Daily')] = weighted_count / total_weight\n\n            # For \"all\" vehicle categories\n            weighted_counts = subset.groupby(category_col)[weight_col].sum()\n            total_weight = subset[weight_col].sum()\n\n            for cat, weighted_count in weighted_counts.items():\n                var_name = f\"{prefix}_{cat}_all\"\n                if var_name not in results:\n                    results[var_name] = {}\n                results[var_name][(purpose, 'Daily')] = weighted_count / total_weight\n\n    # Convert to DataFrame\n    df_result = pd.DataFrame(results).T\n    df_result.columns = pd.MultiIndex.from_tuples(df_result.columns)\n    df_result = df_result.fillna(0)\n\n    # Sort index\n    df_result = df_result.sort_index()\n\n    return df_result\n```\n:::\n\n\n::: {#788f0821 .cell execution_count=4}\n``` {.python .cell-code}\n# Verify categorical shares sum to 1.0000\ndef verify_shares(df_shares, tolerance=0.01):\n    \"\"\"\n    Verify that shares sum to approximately 1 within each group.\n    \"\"\"\n    print(\"=== Verifying Share Sums ===\\n\")\n\n    # Check sums for each column\n    all_good = True\n    issues = []\n\n    for col in df_shares.columns:\n        col_sum = df_shares[col].sum()\n\n        if abs(col_sum - 1.0) > tolerance:\n            all_good = False\n            issues.append((col, col_sum))\n\n    if all_good:\n        print(\"âœ… All shares sum to 1.0 (within tolerance)\")\n    else:\n        print(f\"âš ï¸  Warning: {len(issues)} columns don't sum to 1.0:\\n\")\n        for col, sum_val in issues[:10]:  # Show first 10\n            print(f\"   {col}: {sum_val:.4f}\")\n        if len(issues) > 10:\n            print(f\"   ... and {len(issues) - 10} more\")\n\n    print(f\"\\nTotal columns: {len(df_shares.columns)}\")\n    print(f\"Columns with correct sums: {len(df_shares.columns) - len(issues)}\")\n\n    return df_shares.sum(axis=0)\n```\n:::\n\n\n## Setup BigQuery\n\n\n\n::: {#f8a8db52 .cell execution_count=6}\n``` {.python .cell-code}\n# # Import global TDM functions from remote 'Resource' repo\n\n# Fetch and import BigQuery module\nresponse = fetch_github(\n    'https://raw.githubusercontent.com/WFRCAnalytics/Resources/refs/heads/master/2-Python/global-functions/BigQuery.py',\n    mode=\"public\"\n)\n\nBigQuery = importlib.util.module_from_spec(importlib.util.spec_from_loader('BigQuery', loader=None))\nexec(response.text, BigQuery.__dict__)\n\n# Initiatlize BigQuery Client\nclient = BigQuery.getBigQueryClient_Confidential2023UtahHTS()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\npukar.bhandari\nC:/Users/Pukar.Bhandari/.private/confidential-2023-utah-hts-5fd7ddd219a7.json\n```\n:::\n:::\n\n\n# Load Data\n\n## UTA On-Board Survey\n\n::: {#9dafd93f .cell execution_count=7}\n``` {.python .cell-code}\n# Read Linked UTA On-Board Survey Data directly from GitHub repo\nresponse = fetch_github(\n    \"https://raw.githubusercontent.com/WFRCAnalytics/DATA-OBS-Prep-For-TDM/refs/heads/main/_output/UTA_OBS_2024_Linked.csv\",\n    mode = \"private\"\n)\n\ndf_obs_linked = pd.read_csv(io.StringIO(response.text))\ndf_obs_linked\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nC:\\Users\\Pukar.Bhandari\\AppData\\Local\\Temp\\ipykernel_19912\\4156658631.py:7: DtypeWarning: Columns (8,24,32,37,54,132,137,174) have mixed types. Specify dtype option on import or set low_memory=False.\n  df_obs_linked = pd.read_csv(io.StringIO(response.text))\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=6}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>ID</th>\n      <th>DATE_COMPLETED</th>\n      <th>DATE_TYPE</th>\n      <th>ROUTE_DIRECTION_Code</th>\n      <th>ROUTE_DIRECTION</th>\n      <th>ROUTE_DIRECTION_Other</th>\n      <th>HOME_ADDRESS_CITY</th>\n      <th>HOME_ADDRESS_STATE</th>\n      <th>HOME_ADDRESS_ZIP</th>\n      <th>HOME_ADDRESS_LAT</th>\n      <th>...</th>\n      <th>p_Stop_lat</th>\n      <th>p_Stop_lon</th>\n      <th>a_Stop_lat</th>\n      <th>a_Stop_lon</th>\n      <th>p_Stop_N</th>\n      <th>a_Stop_N</th>\n      <th>access_dist</th>\n      <th>access_time</th>\n      <th>egress_dist</th>\n      <th>egress_time</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>5948</td>\n      <td>2/27/2024</td>\n      <td>Weekday</td>\n      <td>UTA_1_2_00</td>\n      <td>2 200 SOUTH - TO U HOSPITAL</td>\n      <td>NaN</td>\n      <td>Clearfield</td>\n      <td>UT</td>\n      <td>84015</td>\n      <td>41.119565</td>\n      <td>...</td>\n      <td>41.118979</td>\n      <td>-112.025922</td>\n      <td>40.769221</td>\n      <td>-111.898663</td>\n      <td>27702</td>\n      <td>25493</td>\n      <td>0.37</td>\n      <td>0.148000</td>\n      <td>0.68</td>\n      <td>0.27200</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>6067</td>\n      <td>2/27/2024</td>\n      <td>Weekday</td>\n      <td>UTA_1_47_00</td>\n      <td>47 4700 SOUTH - TO W VALLEY CTL</td>\n      <td>NaN</td>\n      <td>West Valley City</td>\n      <td>UT</td>\n      <td>84119</td>\n      <td>40.689590</td>\n      <td>...</td>\n      <td>40.689384</td>\n      <td>-111.967476</td>\n      <td>40.660941</td>\n      <td>-111.899443</td>\n      <td>23195</td>\n      <td>23685</td>\n      <td>0.56</td>\n      <td>0.224000</td>\n      <td>0.24</td>\n      <td>0.09600</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>6069</td>\n      <td>3/16/2024</td>\n      <td>Saturday</td>\n      <td>UTA_1_750_01</td>\n      <td>FRONTRUNNER 750 - SOUTHBOUND</td>\n      <td>NaN</td>\n      <td>Ogden</td>\n      <td>UT</td>\n      <td>84401</td>\n      <td>41.186697</td>\n      <td>...</td>\n      <td>41.188757</td>\n      <td>-112.039378</td>\n      <td>40.784356</td>\n      <td>-111.982117</td>\n      <td>10042</td>\n      <td>15093</td>\n      <td>1.36</td>\n      <td>0.050671</td>\n      <td>0.20</td>\n      <td>0.08000</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>6073</td>\n      <td>2/28/2024</td>\n      <td>Weekday</td>\n      <td>UTA_1_750_01</td>\n      <td>FRONTRUNNER 750 - SOUTHBOUND</td>\n      <td>NaN</td>\n      <td>Ogden</td>\n      <td>UT</td>\n      <td>84401</td>\n      <td>41.236749</td>\n      <td>...</td>\n      <td>41.188757</td>\n      <td>-112.039378</td>\n      <td>40.659758</td>\n      <td>-111.896432</td>\n      <td>10042</td>\n      <td>10016</td>\n      <td>4.17</td>\n      <td>0.136991</td>\n      <td>1.66</td>\n      <td>0.07316</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>6077</td>\n      <td>2/28/2024</td>\n      <td>Weekday</td>\n      <td>UTA_1_47_00</td>\n      <td>47 4700 SOUTH - TO W VALLEY CTL</td>\n      <td>NaN</td>\n      <td>West Valley City</td>\n      <td>UT</td>\n      <td>84119</td>\n      <td>40.669687</td>\n      <td>...</td>\n      <td>40.667711</td>\n      <td>-111.961123</td>\n      <td>40.681907</td>\n      <td>-112.024041</td>\n      <td>22922</td>\n      <td>22421</td>\n      <td>0.25</td>\n      <td>0.100000</td>\n      <td>0.49</td>\n      <td>0.19600</td>\n    </tr>\n    <tr>\n      <th>...</th>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n    </tr>\n    <tr>\n      <th>13790</th>\n      <td>30339</td>\n      <td>4/26/2024</td>\n      <td>Weekday</td>\n      <td>UTA_1_704_01</td>\n      <td>TRAX GREEN LINE 704 - TO AIRPORT</td>\n      <td>NaN</td>\n      <td>Salt Lake City</td>\n      <td>UT</td>\n      <td>84116</td>\n      <td>40.772420</td>\n      <td>...</td>\n      <td>40.771536</td>\n      <td>-111.945736</td>\n      <td>40.771502</td>\n      <td>-111.914486</td>\n      <td>15101</td>\n      <td>15122</td>\n      <td>0.31</td>\n      <td>0.124000</td>\n      <td>0.17</td>\n      <td>0.06800</td>\n    </tr>\n    <tr>\n      <th>13791</th>\n      <td>30340</td>\n      <td>4/26/2024</td>\n      <td>Weekday</td>\n      <td>UTA_1_704_00</td>\n      <td>TRAX GREEN LINE 704 - TO WEST VALLEY</td>\n      <td>NaN</td>\n      <td>Salt Lake City</td>\n      <td>UT</td>\n      <td>84116</td>\n      <td>40.771361</td>\n      <td>...</td>\n      <td>40.771505</td>\n      <td>-111.915361</td>\n      <td>40.750058</td>\n      <td>-111.896818</td>\n      <td>25266</td>\n      <td>15109</td>\n      <td>0.30</td>\n      <td>0.120000</td>\n      <td>1.21</td>\n      <td>0.48400</td>\n    </tr>\n    <tr>\n      <th>13792</th>\n      <td>30341</td>\n      <td>4/26/2024</td>\n      <td>Weekday</td>\n      <td>UTA_1_704_00</td>\n      <td>TRAX GREEN LINE 704 - TO WEST VALLEY</td>\n      <td>NaN</td>\n      <td>Salt Lake City</td>\n      <td>UT</td>\n      <td>84116</td>\n      <td>40.773232</td>\n      <td>...</td>\n      <td>40.771505</td>\n      <td>-111.915361</td>\n      <td>40.725345</td>\n      <td>-111.877499</td>\n      <td>25266</td>\n      <td>24968</td>\n      <td>0.19</td>\n      <td>0.076000</td>\n      <td>0.86</td>\n      <td>0.34400</td>\n    </tr>\n    <tr>\n      <th>13793</th>\n      <td>1000002</td>\n      <td>2/29/2024</td>\n      <td>Weekday</td>\n      <td>UTA_1_701_00</td>\n      <td>TRAX BLUE LINE 701 - TO DRAPER</td>\n      <td>NaN</td>\n      <td>Salt Lake City</td>\n      <td>UT</td>\n      <td>84111</td>\n      <td>40.751607</td>\n      <td>...</td>\n      <td>40.755113</td>\n      <td>-111.891095</td>\n      <td>40.674859</td>\n      <td>-111.943134</td>\n      <td>15123</td>\n      <td>23342</td>\n      <td>0.33</td>\n      <td>0.132000</td>\n      <td>0.29</td>\n      <td>0.11600</td>\n    </tr>\n    <tr>\n      <th>13794</th>\n      <td>1000004</td>\n      <td>2/29/2024</td>\n      <td>Weekday</td>\n      <td>UTA_1_701_00</td>\n      <td>TRAX BLUE LINE 701 - TO DRAPER</td>\n      <td>NaN</td>\n      <td>Salt Lake City</td>\n      <td>UT</td>\n      <td>84109</td>\n      <td>40.722068</td>\n      <td>...</td>\n      <td>40.725878</td>\n      <td>-111.830935</td>\n      <td>40.525496</td>\n      <td>-111.858805</td>\n      <td>25663</td>\n      <td>15041</td>\n      <td>0.79</td>\n      <td>0.316000</td>\n      <td>0.19</td>\n      <td>0.07600</td>\n    </tr>\n  </tbody>\n</table>\n<p>13795 rows Ã— 301 columns</p>\n</div>\n```\n:::\n:::\n\n\n## Household Travel Survey\n\n::: {#d245e635 .cell execution_count=8}\n``` {.python .cell-code}\n# Load Linked Trips data from 2023 Household Travel Survey\ndf_hts_linked = client.query(\n    \"SELECT * FROM \" + 'wfrc-modeling-data.prd_tdm_hts_2023.trip_linked'\n).to_dataframe()\n\ndf_hts_linked\n```\n\n::: {.cell-output .cell-output-display execution_count=7}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>unique_id</th>\n      <th>linked_trip_id</th>\n      <th>hh_id</th>\n      <th>person_id</th>\n      <th>day_id</th>\n      <th>day_weight</th>\n      <th>person_num</th>\n      <th>day_num</th>\n      <th>participation_group</th>\n      <th>diary_platform</th>\n      <th>...</th>\n      <th>dCO_TAZID_USTMv3</th>\n      <th>pCO_TAZID_USTMv3</th>\n      <th>aCO_TAZID_USTMv3</th>\n      <th>oCO_TAZID_USTMv4</th>\n      <th>dCO_TAZID_USTMv4</th>\n      <th>pCO_TAZID_USTMv4</th>\n      <th>aCO_TAZID_USTMv4</th>\n      <th>pSUBAREAID</th>\n      <th>aSUBAREAID</th>\n      <th>trip_weight</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>5facab93-0b23-480f-b69a-70a9d611427c</td>\n      <td>2302328301010100</td>\n      <td>23023283</td>\n      <td>2302328301</td>\n      <td>230232830101</td>\n      <td>785.318580</td>\n      <td>1</td>\n      <td>1</td>\n      <td>1</td>\n      <td>browser</td>\n      <td>...</td>\n      <td>530200.0</td>\n      <td>530278.0</td>\n      <td>530200.0</td>\n      <td>530297.0</td>\n      <td>530323.0</td>\n      <td>530297.0</td>\n      <td>530323.0</td>\n      <td>3.0</td>\n      <td>3.0</td>\n      <td>785.318580</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>27d90255-4acc-42fb-82a7-62e249f739b8</td>\n      <td>2303463801020900</td>\n      <td>23034638</td>\n      <td>2303463801</td>\n      <td>230346380102</td>\n      <td>0.000000</td>\n      <td>1</td>\n      <td>2</td>\n      <td>9</td>\n      <td>rmove</td>\n      <td>...</td>\n      <td>490777.0</td>\n      <td>490777.0</td>\n      <td>490723.0</td>\n      <td>490750.0</td>\n      <td>490757.0</td>\n      <td>490757.0</td>\n      <td>490750.0</td>\n      <td>1.0</td>\n      <td>1.0</td>\n      <td>0.000000</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>3808484f-788b-48e5-a5e1-dba3eec264fa</td>\n      <td>2304417802020100</td>\n      <td>23044178</td>\n      <td>2304417802</td>\n      <td>230441780202</td>\n      <td>79.325700</td>\n      <td>2</td>\n      <td>2</td>\n      <td>9</td>\n      <td>rmove</td>\n      <td>...</td>\n      <td>350673.0</td>\n      <td>350673.0</td>\n      <td>350197.0</td>\n      <td>350197.0</td>\n      <td>350673.0</td>\n      <td>350673.0</td>\n      <td>350197.0</td>\n      <td>1.0</td>\n      <td>1.0</td>\n      <td>79.325700</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>76bc4c44-e8f4-47ff-9c3d-36959467a428</td>\n      <td>2305261901070200</td>\n      <td>23052619</td>\n      <td>2305261901</td>\n      <td>230526190107</td>\n      <td>508.569360</td>\n      <td>1</td>\n      <td>7</td>\n      <td>9</td>\n      <td>rmove</td>\n      <td>...</td>\n      <td>490774.0</td>\n      <td>490774.0</td>\n      <td>490723.0</td>\n      <td>490750.0</td>\n      <td>490754.0</td>\n      <td>490754.0</td>\n      <td>490750.0</td>\n      <td>1.0</td>\n      <td>1.0</td>\n      <td>508.569360</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>4a68e37e-5f7e-4a2b-9448-08ec36f3d318</td>\n      <td>2307491602030100</td>\n      <td>23074916</td>\n      <td>2307491602</td>\n      <td>230749160203</td>\n      <td>0.000000</td>\n      <td>2</td>\n      <td>3</td>\n      <td>9</td>\n      <td>rmove</td>\n      <td>...</td>\n      <td>490497.0</td>\n      <td>490497.0</td>\n      <td>490632.0</td>\n      <td>490715.0</td>\n      <td>490455.0</td>\n      <td>490455.0</td>\n      <td>490715.0</td>\n      <td>1.0</td>\n      <td>1.0</td>\n      <td>0.000000</td>\n    </tr>\n    <tr>\n      <th>...</th>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n    </tr>\n    <tr>\n      <th>13112</th>\n      <td>1019ad4d-6732-45a1-a991-e5a3be830883</td>\n      <td>2348141901030100</td>\n      <td>23481419</td>\n      <td>2348141901</td>\n      <td>234814190103</td>\n      <td>21.199747</td>\n      <td>1</td>\n      <td>3</td>\n      <td>9</td>\n      <td>rmove</td>\n      <td>...</td>\n      <td>350187.0</td>\n      <td>350187.0</td>\n      <td>350189.0</td>\n      <td>350189.0</td>\n      <td>350187.0</td>\n      <td>350187.0</td>\n      <td>350189.0</td>\n      <td>1.0</td>\n      <td>1.0</td>\n      <td>21.199747</td>\n    </tr>\n    <tr>\n      <th>13113</th>\n      <td>adfacfa2-2f88-462d-b7de-17066fa37ece</td>\n      <td>2348219501010100</td>\n      <td>23482195</td>\n      <td>2348219501</td>\n      <td>234821950101</td>\n      <td>68.644470</td>\n      <td>1</td>\n      <td>1</td>\n      <td>9</td>\n      <td>rmove</td>\n      <td>...</td>\n      <td>350562.0</td>\n      <td>350562.0</td>\n      <td>350562.0</td>\n      <td>350562.0</td>\n      <td>350562.0</td>\n      <td>350562.0</td>\n      <td>350562.0</td>\n      <td>1.0</td>\n      <td>1.0</td>\n      <td>68.644470</td>\n    </tr>\n    <tr>\n      <th>13114</th>\n      <td>5c5d7f99-8bb5-49bb-8eb0-2447e9f2abfc</td>\n      <td>2348502802010200</td>\n      <td>23485028</td>\n      <td>2348502802</td>\n      <td>234850280201</td>\n      <td>0.000000</td>\n      <td>2</td>\n      <td>1</td>\n      <td>9</td>\n      <td>rmove</td>\n      <td>...</td>\n      <td>351014.0</td>\n      <td>351203.0</td>\n      <td>351014.0</td>\n      <td>351203.0</td>\n      <td>351014.0</td>\n      <td>351203.0</td>\n      <td>351014.0</td>\n      <td>1.0</td>\n      <td>1.0</td>\n      <td>0.000000</td>\n    </tr>\n    <tr>\n      <th>13115</th>\n      <td>e136d377-68a2-4086-8b89-3a030fdc1ab7</td>\n      <td>2348561501010100</td>\n      <td>23485615</td>\n      <td>2348561501</td>\n      <td>234856150101</td>\n      <td>32.566605</td>\n      <td>1</td>\n      <td>1</td>\n      <td>1</td>\n      <td>browser</td>\n      <td>...</td>\n      <td>350253.0</td>\n      <td>350368.0</td>\n      <td>350253.0</td>\n      <td>350368.0</td>\n      <td>350253.0</td>\n      <td>350368.0</td>\n      <td>350253.0</td>\n      <td>1.0</td>\n      <td>1.0</td>\n      <td>39.079926</td>\n    </tr>\n    <tr>\n      <th>13116</th>\n      <td>e1ba708e-8925-4357-9720-5dec0b126809</td>\n      <td>2348838901050200</td>\n      <td>23488389</td>\n      <td>2348838901</td>\n      <td>234883890105</td>\n      <td>22.466323</td>\n      <td>1</td>\n      <td>5</td>\n      <td>9</td>\n      <td>rmove</td>\n      <td>...</td>\n      <td>110049.0</td>\n      <td>110049.0</td>\n      <td>110053.0</td>\n      <td>110053.0</td>\n      <td>110049.0</td>\n      <td>110049.0</td>\n      <td>110053.0</td>\n      <td>1.0</td>\n      <td>1.0</td>\n      <td>22.466323</td>\n    </tr>\n  </tbody>\n</table>\n<p>232451 rows Ã— 109 columns</p>\n</div>\n```\n:::\n:::\n\n\n# Understanding Mode Hierarchy\n\n```{mermaid}\nflowchart LR\n  T[\"ðŸš¦ Total Trips\"]\n\n  %% Top-level split\n  T --> M[\"Motorized\"]\n  T --> NM[\"Non-motorized\"]\n\n  %% Motorized branch\n  subgraph S1[\"ðŸš— Motorized Transportation\"]\n    direction TB\n    M --> A[\"Auto\"]\n    M --> TR[\"Transit\"]\n\n    %% Auto\n    A --> DA[\"Drive alone\"]\n    A --> SR[\"Shared ride\"]\n    SR --> SR2[\"SR2<br/><i>2 people</i>\"]\n    SR --> SR3[\"SR3<br/><i>3+ people</i>\"]\n\n    %% Transit (two complementary views)\n    subgraph S1a[\"ðŸšŒ Transit â€“ By Service Type\"]\n      direction TB\n      TR --> TM[\"By service type\"]\n      TM --> LB[\"Local bus\"]\n      TM --> CB[\"Core bus\"]\n      TM --> EB[\"Express bus\"]\n      TM --> LRT[\"LRT<br/><i>light rail</i>\"]\n      TM --> CRT[\"CRT<br/><i>commuter rail</i>\"]\n      TM --> BRT[\"BRT<br/><i>bus rapid</i>\"]\n    end\n\n    subgraph S1b[\"ðŸš¶ðŸš— Transit â€“ By Access Type\"]\n      direction TB\n      TR --> TA[\"By access type\"]\n\n      %% Walk-to-transit\n      TA --> WTT[\"ðŸš¶ Walk-to-transit\"]\n      WTT --> WLB[\"Walk â†’ Local bus\"]\n      WTT --> WCB[\"Walk â†’ Core bus\"]\n      WTT --> WEB[\"Walk â†’ Express bus\"]\n      WTT --> WLRT[\"Walk â†’ LRT\"]\n      WTT --> WCRT[\"Walk â†’ CRT\"]\n      WTT --> WBRT[\"Walk â†’ BRT\"]\n\n      %% Drive-to-transit\n      TA --> DTT[\"ðŸš— Drive-to-transit\"]\n      DTT --> DLB[\"Drive â†’ Local bus\"]\n      DTT --> DCB[\"Drive â†’ Core bus\"]\n      DTT --> DEB[\"Drive â†’ Express bus\"]\n      DTT --> DLRT[\"Drive â†’ LRT\"]\n      DTT --> DCRT[\"Drive â†’ CRT\"]\n      DTT --> DBRT[\"Drive â†’ BRT\"]\n    end\n  end\n\n  %% Non-motorized branch\n  subgraph S2[\"ðŸš¶ Non-motorized Transportation\"]\n    direction TB\n    NM --> WALK[\"Walk\"]\n    NM --> BIKE[\"Bike\"]\n  end\n\n  %% Styling\n  classDef rootNode fill:#2c3e50,stroke:#34495e,stroke-width:3px,color:#fff,font-weight:bold,font-size:16px\n  classDef motorizedNode fill:#3498db,stroke:#2980b9,stroke-width:2px,color:#fff,font-weight:bold\n  classDef nonMotorizedNode fill:#27ae60,stroke:#229954,stroke-width:2px,color:#fff,font-weight:bold\n  classDef autoNode fill:#e67e22,stroke:#d35400,stroke-width:2px,color:#fff\n  classDef transitNode fill:#9b59b6,stroke:#8e44ad,stroke-width:2px,color:#fff\n  classDef walkTransitNode fill:#1abc9c,stroke:#16a085,stroke-width:2px,color:#fff\n  classDef driveTransitNode fill:#e74c3c,stroke:#c0392b,stroke-width:2px,color:#fff\n  classDef leafNode fill:#ecf0f1,stroke:#95a5a6,stroke-width:1px,color:#2c3e50\n  classDef subgraphStyle fill:#f8f9fa,stroke:#dee2e6,stroke-width:2px\n\n  class T rootNode\n  class M motorizedNode\n  class NM nonMotorizedNode\n  class A,DA,SR,SR2,SR3 autoNode\n  class TR,TM,TA transitNode\n  class WTT,WLB,WCB,WEB,WLRT,WCRT,WBRT walkTransitNode\n  class DTT,DLB,DCB,DEB,DLRT,DCRT,DBRT driveTransitNode\n  class LB,CB,EB,LRT,CRT,BRT,WALK,BIKE leafNode\n```\n\n\n# Identify Variable of Interest\n\n## On-Board Survey\n\n::: {#872a19fd .cell execution_count=9}\n``` {.python .cell-code}\ndf_obs_linked[[\n    \"Linked_Mode_txt\", # Linked Mode: MT = MicroTransit (dont need), LCL = local bus, COR = Core Bus, EXP = Express Bus, LRT = Light Rail Transit (TRAX), CRT = Commuter Rail Transit (FrontRunner), BRT = Bus Rapid Transit (OVX, UVX)\n    \"Purp5_text\", # Trip Purpose: HBW = Home-based Work, HBO = Home-based Other, HBC = Home-based College, NHB = Non-home based, HBSch = Home-based School\n    \"PK_OK\", # Peak vs OffPeak\n    \"Veh_Cat3p\", # Vehicle Ownership: 0 = 0 Vehicle Household, 1 = 1 Vehicle Household, 2 = 2 Vehicle Household, 3 = 3+ Vehicle Household\n    \"Mode_Fin\", # Current Mode: 1 = MT = MicroTransit (Dont need),  4 = LCL = local bus, 5 = COR = Core Bus, 6 = EXP = Express Bus, 7 = LRT = Light Rail Transit (TRAX), 8 = CRT = Commuter Rail Transit, 9 = BRT = Bus Rapid Transit (OVX, UVX)\n    \"Ac_Mode_Model\", # Access Mode to Transit: Walk (Walk to Transit), Drive (Drive to Transit)\n]]\n```\n\n::: {.cell-output .cell-output-display execution_count=8}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>Linked_Mode_txt</th>\n      <th>Purp5_text</th>\n      <th>PK_OK</th>\n      <th>Veh_Cat3p</th>\n      <th>Mode_Fin</th>\n      <th>Ac_Mode_Model</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>LCL</td>\n      <td>HBW</td>\n      <td>PK</td>\n      <td>0</td>\n      <td>4</td>\n      <td>Walk</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>LCL</td>\n      <td>HBC</td>\n      <td>OK</td>\n      <td>0</td>\n      <td>4</td>\n      <td>Walk</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>LRT</td>\n      <td>HBO</td>\n      <td>OK</td>\n      <td>1</td>\n      <td>8</td>\n      <td>Drive</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>CRT</td>\n      <td>HBW</td>\n      <td>OK</td>\n      <td>2</td>\n      <td>8</td>\n      <td>Drive</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>LCL</td>\n      <td>HBW</td>\n      <td>OK</td>\n      <td>0</td>\n      <td>4</td>\n      <td>Walk</td>\n    </tr>\n    <tr>\n      <th>...</th>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n    </tr>\n    <tr>\n      <th>13790</th>\n      <td>LRT</td>\n      <td>HBO</td>\n      <td>OK</td>\n      <td>1</td>\n      <td>7</td>\n      <td>Walk</td>\n    </tr>\n    <tr>\n      <th>13791</th>\n      <td>LRT</td>\n      <td>NHB</td>\n      <td>OK</td>\n      <td>0</td>\n      <td>7</td>\n      <td>Walk</td>\n    </tr>\n    <tr>\n      <th>13792</th>\n      <td>LCL</td>\n      <td>NHB</td>\n      <td>OK</td>\n      <td>1</td>\n      <td>7</td>\n      <td>Walk</td>\n    </tr>\n    <tr>\n      <th>13793</th>\n      <td>LCL</td>\n      <td>HBC</td>\n      <td>PK</td>\n      <td>3</td>\n      <td>7</td>\n      <td>Walk</td>\n    </tr>\n    <tr>\n      <th>13794</th>\n      <td>LCL</td>\n      <td>HBW</td>\n      <td>OK</td>\n      <td>1</td>\n      <td>7</td>\n      <td>Walk</td>\n    </tr>\n  </tbody>\n</table>\n<p>13795 rows Ã— 6 columns</p>\n</div>\n```\n:::\n:::\n\n\n# Trips: Motorized vs Non-motorized\n\n\n\n## Non-motorized Trips: Walk vs Bike\n\n\n\n## Motorized Trips: Auto vs Transit\n\n\n\n### Auto Trips: Drive Alone vs Shared Rides\n\n\n\n#### Shared Rides: 2 People vs 3+ People\n\n\n\n### Transit Trips: By Service and By Access Mode\n\n#### By Service Type\n\n::: {#e16ebc5d .cell execution_count=10}\n``` {.python .cell-code}\n# 1. Transit by Service Type (within linked transit trips)\nprint(\"\\n\" + \"=\" * 60)\nprint(\"1. TRANSIT BY SERVICE TYPE\")\nprint(\"=\" * 60)\n\nservice_mapping = {\n    'LCL': 'local',\n    'COR': 'core',\n    'EXP': 'express',\n    'LRT': 'lrt',\n    'CRT': 'crt',\n    'BRT': 'brt'\n}\n\ndf_transit_by_service = calculate_categorical_shares(\n    df_obs_linked,\n    category_col='Linked_Mode_txt',\n    weight_col='LINKED_WEIGHT',\n    group_cols=['Veh_Cat3p', 'Purp5_text', 'PK_OK'],\n    filter_condition='Linked_Mode_txt != \"MT\"',\n    category_mapping=service_mapping,\n    prefix='calib_share'\n)\n\nprint(\"\\nShape:\", df_transit_by_service.shape)\nprint(\"\\nFirst few rows:\")\nprint(df_transit_by_service.head(10))\nprint(\"\\nVerification:\")\nverify_shares(df_transit_by_service)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n============================================================\n1. TRANSIT BY SERVICE TYPE\n============================================================\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nC:\\Users\\Pukar.Bhandari\\AppData\\Local\\Temp\\ipykernel_19912\\2056282771.py:47: SettingWithCopyWarning: \nA value is trying to be set on a copy of a slice from a DataFrame.\nTry using .loc[row_indexer,col_indexer] = value instead\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n  df_work[category_col] = df_work[category_col].map(category_mapping)\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n\nShape: (5, 12)\n\nFirst few rows:\n                              HBC                 HBO               HBSch  \\\n                               OK        PK        OK        PK        OK   \ncalib_share_brt_all      0.295180  0.235873  0.076085  0.071583  0.073582   \ncalib_share_crt_all      0.068098  0.083201  0.042798  0.039035  0.027174   \ncalib_share_express_all  0.000000  0.001163  0.000000  0.001306  0.000000   \ncalib_share_local_all    0.459143  0.448081  0.509093  0.482018  0.781475   \ncalib_share_lrt_all      0.177579  0.231682  0.372024  0.406058  0.117769   \n\n                                        HBW                 NHB            \\\n                               PK        OK        PK        OK        PK   \ncalib_share_brt_all      0.027199  0.045846  0.052426  0.158804  0.108415   \ncalib_share_crt_all      0.026417  0.074069  0.093561  0.025010  0.033162   \ncalib_share_express_all  0.000000  0.006696  0.013234  0.000000  0.000000   \ncalib_share_local_all    0.769791  0.500620  0.508396  0.445302  0.468599   \ncalib_share_lrt_all      0.176593  0.372770  0.332383  0.370883  0.389823   \n\n                              HBC     HBSch  \n                            Daily     Daily  \ncalib_share_brt_all      0.268888  0.049344  \ncalib_share_crt_all      0.074794  0.026778  \ncalib_share_express_all  0.000515  0.000000  \ncalib_share_local_all    0.454239  0.775369  \ncalib_share_lrt_all      0.201564  0.148509  \n\nVerification:\n=== Verifying Share Sums ===\n\nâœ… All shares sum to 1.0 (within tolerance)\n\nTotal columns: 12\nColumns with correct sums: 12\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=9}\n```\nHBC    OK       1.0\n       PK       1.0\nHBO    OK       1.0\n       PK       1.0\nHBSch  OK       1.0\n       PK       1.0\nHBW    OK       1.0\n       PK       1.0\nNHB    OK       1.0\n       PK       1.0\nHBC    Daily    1.0\nHBSch  Daily    1.0\ndtype: float64\n```\n:::\n:::\n\n\n#### By Access Mode: Walk vs Drive to Transit\n\n::: {#f289fe15 .cell execution_count=11}\n``` {.python .cell-code}\n# 2. Transit by Access Type (Walk vs Drive) (within linked transit trips)\nprint(\"\\n\" + \"=\" * 60)\nprint(\"2. TRANSIT BY ACCESS TYPE\")\nprint(\"=\" * 60)\n\naccess_mapping = {\n    'Walk': 'walkacc',\n    'Drive': 'driveacc'\n}\n\ndf_transit_by_access = calculate_categorical_shares(\n    df_obs_linked,\n    category_col='Ac_Mode_Model',\n    weight_col='LINKED_WEIGHT',\n    group_cols=['Veh_Cat3p', 'Purp5_text', 'PK_OK'],\n    filter_condition='Linked_Mode_txt != \"MT\"',\n    category_mapping=access_mapping,\n    prefix='calib_share'\n)\n\nprint(\"\\nShape:\", df_transit_by_access.shape)\nprint(\"\\nFirst few rows:\")\nprint(df_transit_by_access.head(10))\nprint(\"\\nVerification:\")\nverify_shares(df_transit_by_access)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n============================================================\n2. TRANSIT BY ACCESS TYPE\n============================================================\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nC:\\Users\\Pukar.Bhandari\\AppData\\Local\\Temp\\ipykernel_19912\\2056282771.py:47: SettingWithCopyWarning: \nA value is trying to be set on a copy of a slice from a DataFrame.\nTry using .loc[row_indexer,col_indexer] = value instead\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n  df_work[category_col] = df_work[category_col].map(category_mapping)\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n\nShape: (2, 12)\n\nFirst few rows:\n                               HBC                 HBO              HBSch  \\\n                                OK        PK        OK       PK        OK   \ncalib_share_driveacc_all  0.284102  0.324053  0.120454  0.12685  0.055021   \ncalib_share_walkacc_all   0.715898  0.675947  0.879546  0.87315  0.944979   \n\n                                         HBW                 NHB            \\\n                                PK        OK        PK        OK        PK   \ncalib_share_driveacc_all  0.165856  0.188193  0.233531  0.044846  0.059741   \ncalib_share_walkacc_all   0.834144  0.811807  0.766469  0.955154  0.940259   \n\n                               HBC     HBSch  \n                             Daily     Daily  \ncalib_share_driveacc_all  0.301813  0.112939  \ncalib_share_walkacc_all   0.698187  0.887061  \n\nVerification:\n=== Verifying Share Sums ===\n\nâœ… All shares sum to 1.0 (within tolerance)\n\nTotal columns: 12\nColumns with correct sums: 12\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=10}\n```\nHBC    OK       1.0\n       PK       1.0\nHBO    OK       1.0\n       PK       1.0\nHBSch  OK       1.0\n       PK       1.0\nHBW    OK       1.0\n       PK       1.0\nNHB    OK       1.0\n       PK       1.0\nHBC    Daily    1.0\nHBSch  Daily    1.0\ndtype: float64\n```\n:::\n:::\n\n\n##### Walk to Transit\n\n::: {#f431e6b4 .cell execution_count=12}\n``` {.python .cell-code}\n# 3. Walk-to-Transit by Service Type (within walk-to-transit trips)\nprint(\"\\n\" + \"=\" * 60)\nprint(\"3. WALK-TO-TRANSIT BY SERVICE TYPE\")\nprint(\"=\" * 60)\n\nwalk_service_mapping = {\n    'LCL': 'walk-local',\n    'EXP': 'walk-express',\n    'LRT': 'walk-lrt',\n    'CRT': 'walk-crt',\n    'BRT': 'walk-brt'\n}\n\ndf_walk_to_transit = calculate_categorical_shares(\n    df_obs_linked,\n    category_col='Linked_Mode_txt',\n    weight_col='LINKED_WEIGHT',\n    group_cols=['Veh_Cat3p', 'Purp5_text', 'PK_OK'],\n    filter_condition='Ac_Mode_Model == \"Walk\" & Linked_Mode_txt != \"MT\"',\n    category_mapping=walk_service_mapping,\n    prefix='calib_share'\n)\n\n\nprint(\"\\nShape:\", df_walk_to_transit.shape)\nprint(\"\\nFirst few rows:\")\nprint(df_walk_to_transit.head(10))\nprint(\"\\nVerification:\")\nverify_shares(df_walk_to_transit)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n============================================================\n3. WALK-TO-TRANSIT BY SERVICE TYPE\n============================================================\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nC:\\Users\\Pukar.Bhandari\\AppData\\Local\\Temp\\ipykernel_19912\\2056282771.py:47: SettingWithCopyWarning: \nA value is trying to be set on a copy of a slice from a DataFrame.\nTry using .loc[row_indexer,col_indexer] = value instead\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n  df_work[category_col] = df_work[category_col].map(category_mapping)\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n\nShape: (5, 12)\n\nFirst few rows:\n                                   HBC                 HBO            \\\n                                    OK        PK        OK        PK   \ncalib_share_walk-brt_all      0.297607  0.218401  0.084745  0.079797   \ncalib_share_walk-crt_all      0.016093  0.013708  0.012874  0.006756   \ncalib_share_walk-express_all  0.000000  0.000834  0.000000  0.001017   \ncalib_share_walk-local_all    0.527019  0.546157  0.554165  0.526032   \ncalib_share_walk-lrt_all      0.159281  0.220899  0.348216  0.386398   \n\n                                 HBSch                 HBW            \\\n                                    OK        PK        OK        PK   \ncalib_share_walk-brt_all      0.059241  0.024420  0.052287  0.058774   \ncalib_share_walk-crt_all      0.003367  0.000000  0.039720  0.041360   \ncalib_share_walk-express_all  0.000000  0.000000  0.001909  0.004684   \ncalib_share_walk-local_all    0.816277  0.868024  0.566760  0.603414   \ncalib_share_walk-lrt_all      0.121115  0.107556  0.339324  0.291767   \n\n                                   NHB                 HBC     HBSch  \n                                    OK        PK     Daily     Daily  \ncalib_share_walk-brt_all      0.161801  0.114137  0.263611  0.042130  \ncalib_share_walk-crt_all      0.011054  0.020001  0.015070  0.001712  \ncalib_share_walk-express_all  0.000000  0.000000  0.000358  0.000000  \ncalib_share_walk-local_all    0.463524  0.482216  0.535233  0.841705  \ncalib_share_walk-lrt_all      0.363621  0.383646  0.185728  0.114452  \n\nVerification:\n=== Verifying Share Sums ===\n\nâœ… All shares sum to 1.0 (within tolerance)\n\nTotal columns: 12\nColumns with correct sums: 12\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=11}\n```\nHBC    OK       1.0\n       PK       1.0\nHBO    OK       1.0\n       PK       1.0\nHBSch  OK       1.0\n       PK       1.0\nHBW    OK       1.0\n       PK       1.0\nNHB    OK       1.0\n       PK       1.0\nHBC    Daily    1.0\nHBSch  Daily    1.0\ndtype: float64\n```\n:::\n:::\n\n\n##### Drive to Transit\n\n::: {#2ff5b600 .cell execution_count=13}\n``` {.python .cell-code}\n# 4. Drive-to-Transit by Service Type (within drive-to-transit trips)\nprint(\"\\n\" + \"=\" * 60)\nprint(\"4. DRIVE-TO-TRANSIT BY SERVICE TYPE\")\nprint(\"=\" * 60)\n\ndrive_service_mapping = {\n    'LCL': 'drive-local',\n    'EXP': 'drive-express',\n    'LRT': 'drive-lrt',\n    'CRT': 'drive-crt',\n    'BRT': 'drive-brt'\n}\n\ndf_drive_to_transit = calculate_categorical_shares(\n    df_obs_linked,\n    category_col='Linked_Mode_txt',\n    weight_col='LINKED_WEIGHT',\n    group_cols=['Veh_Cat3p', 'Purp5_text', 'PK_OK'],\n    filter_condition='Ac_Mode_Model == \"Drive\" & Linked_Mode_txt != \"MT\"',\n    category_mapping=drive_service_mapping,\n    prefix='calib_share'\n)\n\nprint(\"\\nShape:\", df_drive_to_transit.shape)\nprint(\"\\nFirst few rows:\")\nprint(df_drive_to_transit.head(10))\nprint(\"\\nVerification:\")\nverify_shares(df_drive_to_transit)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n============================================================\n4. DRIVE-TO-TRANSIT BY SERVICE TYPE\n============================================================\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nC:\\Users\\Pukar.Bhandari\\AppData\\Local\\Temp\\ipykernel_19912\\2056282771.py:47: SettingWithCopyWarning: \nA value is trying to be set on a copy of a slice from a DataFrame.\nTry using .loc[row_indexer,col_indexer] = value instead\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n  df_work[category_col] = df_work[category_col].map(category_mapping)\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n\nShape: (5, 12)\n\nFirst few rows:\n                                    HBC                 HBO            \\\n                                     OK        PK        OK        PK   \ncalib_share_drive-brt_all      0.289065  0.272318  0.012846  0.015046   \ncalib_share_drive-crt_all      0.199144  0.228157  0.261305  0.261220   \ncalib_share_drive-express_all  0.000000  0.001847  0.000000  0.003297   \ncalib_share_drive-local_all    0.288105  0.243502  0.179979  0.179055   \ncalib_share_drive-lrt_all      0.223685  0.254175  0.545870  0.541382   \n\n                                  HBSch                 HBW            \\\n                                     OK        PK        OK        PK   \ncalib_share_drive-brt_all      0.319894  0.041174  0.018059  0.031589   \ncalib_share_drive-crt_all      0.436062  0.159275  0.222239  0.264888   \ncalib_share_drive-express_all  0.000000  0.000000  0.027348  0.041295   \ncalib_share_drive-local_all    0.183738  0.275747  0.215311  0.196538   \ncalib_share_drive-lrt_all      0.060307  0.523803  0.517044  0.465690   \n\n                                    NHB                 HBC     HBSch  \n                                     OK        PK     Daily     Daily  \ncalib_share_drive-brt_all      0.094966  0.018370  0.281094  0.106002  \ncalib_share_drive-crt_all      0.322260  0.240296  0.212954  0.223654  \ncalib_share_drive-express_all  0.000000  0.000000  0.000879  0.000000  \ncalib_share_drive-local_all    0.057220  0.254282  0.266874  0.254347  \ncalib_share_drive-lrt_all      0.525554  0.487052  0.238198  0.415998  \n\nVerification:\n=== Verifying Share Sums ===\n\nâœ… All shares sum to 1.0 (within tolerance)\n\nTotal columns: 12\nColumns with correct sums: 12\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=12}\n```\nHBC    OK       1.0\n       PK       1.0\nHBO    OK       1.0\n       PK       1.0\nHBSch  OK       1.0\n       PK       1.0\nHBW    OK       1.0\n       PK       1.0\nNHB    OK       1.0\n       PK       1.0\nHBC    Daily    1.0\nHBSch  Daily    1.0\ndtype: float64\n```\n:::\n:::\n\n\n",
    "supporting": [
      "index_files\\figure-html"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js\" integrity=\"sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js\" integrity=\"sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}