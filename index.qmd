---
title: Calculating the Mode Choice Calibration Parameters
subtitle: Using Household Travel Survey and UTA On-Board Survey Data
description: Lorem Ipsum
author:
 - name: Pukar Bhandari
   email: pukar.bhandari@wfrc.utah.gov
   affiliation:
     - name: Wasatch Front Regional Council
       url: "https://wfrc.utah.gov/"
date: "2025-11-03"
---

# Setup Environment

This section prepares the Python environment with all necessary libraries and configurations. We'll import data manipulation libraries (pandas, numpy), and visualization tools (matplotlib, seaborn).

## Install Libraries

```python
!conda install -c conda-forge numpy pandas matplotlib seaborn requests pathlib BigQuery
```

## Import Libraries

```{python}
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns

import importlib.util
from pathlib import Path
import sys
import os
import requests
import io

from dotenv import load_dotenv
load_dotenv()
```

## Environment Variables



## Helper Functions

```{python}
def fetch_github(
    url: str,
    mode: str = "private",
    token_env_var: str = "GITHUB_TOKEN"
) -> requests.Response:
    """
    Fetch content from GitHub repositories.

    Args:
        url: GitHub raw URL (e.g., https://raw.githubusercontent.com/...)
        mode: "public" for public repos, "private" for private repos requiring authentication
        token_env_var: Name of environment variable containing GitHub token (default: GITHUB_TOKEN)

    Returns:
        requests.Response object

    Raises:
        ValueError: If token is missing for private mode or invalid mode
        requests.HTTPError: If request fails
    """
    # Validate mode
    if mode not in ["public", "private"]:
        raise ValueError(f"mode must be 'public' or 'private', got '{mode}'")

    if mode == "public":
        response = requests.get(url, timeout=30)
    else:
        token = os.getenv(token_env_var)
        if not token:
            raise ValueError(
                f"GitHub token not found in environment variable '{token_env_var}'. "
                f"Check your .env file has: {token_env_var}=your_token_here"
            )

        headers = {
            'Authorization': f'token {token}',
            'Accept': 'application/vnd.github.v3.raw'
        }
        response = requests.get(url, headers=headers, timeout=30)

    response.raise_for_status()
    return response
```

## Setup BigQuery

```{python}
#| eval: false
#| echo: false

# # Import global TDM functions from local 'Resource' clone

# import sys
# sys.path.insert(0, '../Resources/2-Python/global-functions')
# import BigQuery

# client = BigQuery.getBigQueryClient_Confidential2023UtahHTS()
```

```{python}
# # Import global TDM functions from remote 'Resource' repo

# Fetch and import BigQuery module
response = fetch_github(
    'https://raw.githubusercontent.com/WFRCAnalytics/Resources/refs/heads/master/2-Python/global-functions/BigQuery.py',
    mode="public"
)

BigQuery = importlib.util.module_from_spec(importlib.util.spec_from_loader('BigQuery', loader=None))
exec(response.text, BigQuery.__dict__)

# Initiatlize BigQuery Client
client = BigQuery.getBigQueryClient_Confidential2023UtahHTS()
```

# Load Data

## UTA On-Board Survey

```{python}
# Read Processed UTA On-Board Survey Data directly from GitHub repo
response = fetch_github(
    "https://raw.githubusercontent.com/WFRCAnalytics/DATA-OBS-Prep-For-TDM/refs/heads/main/_output/UTA_OBS_2024_Processed.csv",
    mode = "private"
)

df_obs_processed = pd.read_csv(io.StringIO(response.text))
df_obs_processed
```

## Household Travel Survey

```{python}
# Load Household-level data from 2023 Household Travel Survey
df_hts_hh23 = client.query(
    "SELECT * FROM " + 'wfrc-modeling-data.prd_tdm_hts_2023.hh'
).to_dataframe()

df_hts_hh23
```

```{python}
# Load Person-level data from 2023 Household Travel Survey
df_hts_person23 = client.query(
    "SELECT * FROM " + 'wfrc-modeling-data.prd_tdm_hts_2023.person'
).to_dataframe()

df_hts_person23
```

# Understanding Mode Hierarchy

```{mermaid}
flowchart LR
  T["ðŸš¦ Total Trips"]

  %% Top-level split
  T --> M["Motorized"]
  T --> NM["Non-motorized"]

  %% Motorized branch
  subgraph S1["ðŸš— Motorized Transportation"]
    direction TB
    M --> A["Auto"]
    M --> TR["Transit"]

    %% Auto
    A --> DA["Drive alone"]
    A --> SR["Shared ride"]
    SR --> SR2["SR2<br/><i>2 people</i>"]
    SR --> SR3["SR3<br/><i>3+ people</i>"]

    %% Transit (two complementary views)
    subgraph S1a["ðŸšŒ Transit â€“ By Service Type"]
      direction TB
      TR --> TM["By modes"]
      TM --> LB["Local bus"]
      TM --> CB["Core bus"]
      TM --> EB["Express bus"]
      TM --> LRT["LRT<br/><i>light rail</i>"]
      TM --> CRT["CRT<br/><i>commuter rail</i>"]
      TM --> BRT["BRT<br/><i>bus rapid</i>"]
    end

    subgraph S1b["ðŸš¶ðŸš— Transit â€“ By Access Type"]
      direction TB
      TR --> TA["By access type"]

      %% Walk-to-transit
      TA --> WTT["ðŸš¶ Walk-to-transit"]
      WTT --> WLB["Walk â†’ Local bus"]
      WTT --> WCB["Walk â†’ Core bus"]
      WTT --> WEB["Walk â†’ Express bus"]
      WTT --> WLRT["Walk â†’ LRT"]
      WTT --> WCRT["Walk â†’ CRT"]
      WTT --> WBRT["Walk â†’ BRT"]

      %% Drive-to-transit
      TA --> DTT["ðŸš— Drive-to-transit"]
      DTT --> DLB["Drive â†’ Local bus"]
      DTT --> DCB["Drive â†’ Core bus"]
      DTT --> DEB["Drive â†’ Express bus"]
      DTT --> DLRT["Drive â†’ LRT"]
      DTT --> DCRT["Drive â†’ CRT"]
      DTT --> DBRT["Drive â†’ BRT"]
    end
  end

  %% Non-motorized branch
  subgraph S2["ðŸš¶ Non-motorized Transportation"]
    direction TB
    NM --> WALK["Walk"]
    NM --> BIKE["Bike"]
  end

  %% Styling
  classDef rootNode fill:#2c3e50,stroke:#34495e,stroke-width:3px,color:#fff,font-weight:bold,font-size:16px
  classDef motorizedNode fill:#3498db,stroke:#2980b9,stroke-width:2px,color:#fff,font-weight:bold
  classDef nonMotorizedNode fill:#27ae60,stroke:#229954,stroke-width:2px,color:#fff,font-weight:bold
  classDef autoNode fill:#e67e22,stroke:#d35400,stroke-width:2px,color:#fff
  classDef transitNode fill:#9b59b6,stroke:#8e44ad,stroke-width:2px,color:#fff
  classDef walkTransitNode fill:#1abc9c,stroke:#16a085,stroke-width:2px,color:#fff
  classDef driveTransitNode fill:#e74c3c,stroke:#c0392b,stroke-width:2px,color:#fff
  classDef leafNode fill:#ecf0f1,stroke:#95a5a6,stroke-width:1px,color:#2c3e50
  classDef subgraphStyle fill:#f8f9fa,stroke:#dee2e6,stroke-width:2px

  class T rootNode
  class M motorizedNode
  class NM nonMotorizedNode
  class A,DA,SR,SR2,SR3 autoNode
  class TR,TM,TA transitNode
  class WTT,WLB,WCB,WEB,WLRT,WCRT,WBRT walkTransitNode
  class DTT,DLB,DCB,DEB,DLRT,DCRT,DBRT driveTransitNode
  class LB,CB,EB,LRT,CRT,BRT,WALK,BIKE leafNode
```


# Identify Variable of Interest

## On-Board Survey

### Trip Purposes

```{python}
df_obs_processed["Purp5_text"].value_counts() # Trip Purpose: HBW, HBO, HBC, NHB, HBSch
```

### Peak vs Off-Peak

```{python}
df_obs_processed["PK_OK"].value_counts() # Peak vs Off-Peak
```

### Motorized vs Non-motorized

```{python}
df_obs_processed["Ac_Mode_Model"].value_counts() # Motorized (Drive) vs Non-motorized (Walk)
```

### Vehicle Ownership

```{python}
df_obs_processed["Veh_Cat3p"].value_counts() # Vehile Ownership Category: 0, 1, 2, 3+
```

## Household Travel Survey
